
\documentclass[a4paper,UKenglish,cleveref, autoref, thm-restate, numberwithinsect]{lipics-v2021}
%This is a template for producing LIPIcs articles.
%See lipics-v2021-authors-guidelines.pdf for further information.
%for A4 paper format use option "a4paper", for US-letter use option "letterpaper"
%for british hyphenation rules use option "UKenglish", for american hyphenation rules use option "USenglish"
%for section-numbered lemmas etc., use "numberwithinsect"
%for enabling cleveref support, use "cleveref"
%for enabling autoref support, use "autoref"
%for anonymousing the authors (e.g. for double-blind review), add "anonymous"
%for enabling thm-restate support, use "thm-restate"
%for enabling a two-column layout for the author/affilation part (only applicable for > 6 authors), use "authorcolumns"
%for producing a PDF according the PDF/A standard, add "pdfa"

%\pdfoutput=1 %uncomment to ensure pdflatex processing (mandatatory e.g. to submit to arXiv)
%\hideLIPIcs  %uncomment to remove references to LIPIcs series (logo, DOI, ...), e.g. when preparing a pre-final version to be uploaded to arXiv or another public repository

%\graphicspath{{./graphics/}}%helpful if your graphic files are in another directory

\usepackage[dvipsnames]{xcolor}
% Needed for tikz
\usepackage{tikzit}

\input{style1.tikzstyles}

\bibliographystyle{plainurl}% the mandatory bibstyle

\title{Results on the Separation of Conditional XPath} %TODO: Please add

%\titlerunning{Dummy short title} %TODO: optional, please use if title is longer than one line

\author{V.R. Sathiyanarayana}{Chennai Mathematical Institute, India \and \url{http://sathiyavrs.netlify.app}}{sathiyanarayana@cmi.ac.in}{}{}%TODO mandatory, please use full name; only 1 author per \author macro; first two parameters are mandatory, other parameters can be empty. Please provide at least the name of the affiliation and the country. The full address is optional. Use additional curly braces to indicate the correct name splitting when the last name consists of multiple name parts.

%\author{Joan R. Public\footnote{Optional footnote, e.g. to mark corresponding author}}{Department of Informatics, Dummy College, [optional: Address], Country}{joanrpublic@dummycollege.org}{[orcid]}{[funding]}

\authorrunning{V.R. Sathiyanarayana} % mandatory. First: Use abbreviated first/middle names. Second (only in severe cases): Use first author plus 'et al.'

\Copyright{Jane Open Access and Joan R. Public} %TODO: mandatory, please use full first names. LIPIcs license is "CC-BY";  http://creativecommons.org/licenses/by/3.0/ % TODO: Fill something here

\begin{CCSXML}
<ccs2012>
<concept>
<concept_id>10003752.10003790.10003793</concept_id>
<concept_desc>Theory of computation~Modal and temporal logics</concept_desc>
<concept_significance>500</concept_significance>
</concept>
</ccs2012>
\end{CCSXML}

\ccsdesc[500]{Theory of computation~Modal and temporal logics}

%\ccsdesc[100]{\textcolor{red}{Replace ccsdesc macro with valid one}} %TODO mandatory: Please choose ACM 2012 classifications from https://dl.acm.org/ccs/ccs_flat.cfm

\keywords{Logic, Modal and temporal logic} %TODO mandatory; please add comma-separated list of keywords

\category{} %optional, e.g. invited paper

\relatedversion{} %optional, e.g. full version hosted on arXiv, HAL, or other respository/website
%\relatedversiondetails[linktext={opt. text shown instead of the URL}, cite=DBLP:books/mk/GrayR93]{Classification (e.g. Full Version, Extended Version, Previous Version}{URL to related version} %linktext and cite are optional

%\supplement{}%optional, e.g. related research data, source code, ... hosted on a repository like zenodo, figshare, GitHub, ...
%\supplementdetails[linktext={opt. text shown instead of the URL}, cite=DBLP:books/mk/GrayR93, subcategory={Description, Subcategory}, swhid={Software Heritage Identifier}]{General Classification (e.g. Software, Dataset, Model, ...)}{URL to related version} %linktext, cite, and subcategory are optional

%\funding{(Optional) general funding statement \dots}%optional, to capture a funding statement, which applies to all authors. Please enter author specific funding statements as fifth argument of the \author macro.

\acknowledgements{I want to thank my advisors \href{https://www.cmi.ac.in/~aiswarya/}{Prof. C. Aiswarya} and \href{http://www.lsv.fr/~gastin/}{Prof. Paul Gastin} for the incredible amount of advice, encouragement, and direction they provided during the difficult parts of this endeavour.}%optional

\nolinenumbers %uncomment to disable line numbering

%Editor-only macros:: begin (do not touch as author)%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\EventEditors{John Q. Open and Joan R. Access}
\EventNoEds{2}
\EventLongTitle{42nd Conference on Very Important Topics (CVIT 2016)}
\EventShortTitle{CVIT 2016}
\EventAcronym{CVIT}
\EventYear{2016}
\EventDate{December 24--27, 2016}
\EventLocation{Little Whinging, United Kingdom}
\EventLogo{}
\SeriesVolume{42}
\ArticleNo{23}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% A few shortcuts for Leftarrow, etc
\def\Larrow{\ensuremath\mathord{\Leftarrow}}
\def\Rarrow{\ensuremath\mathord{\Rightarrow}}
\def\Uarrow{\ensuremath\mathord{\Uparrow}}
\def\Darrow{\ensuremath\mathord{\Downarrow}}

\begin{document}

\maketitle

%TODO mandatory: add short abstract of the document
\begin{abstract}
    Separation was introduced by Dov Gabbay for the $S, U$ temporal language over linear time and was shown to imply its expressive equivalence with the first-order monadic logic of order. The flexibility of Gabbay's arguments inspired the popular technique of proving the expressive completeness of a temporal language by showing how it can be separated.

    Attempts have been made to prove separation results for temporal logics that model time differently. Marx proposed a separation for Conditional XPath, the core of which is a natural and expressively-complete temporal language over ordered trees. Sadly, he made a mistake in his proof. In this thesis, we prove some implications of Marx's work, and show a result that discourages the accuracy of his proposed separation.
\end{abstract}

\section{Introduction}
\label{sec:introduction}

Temporal logics are excellent languages for making statements about systems that change over time. A variety of these logics have been studied; some differ in the way they model time, some in the way they interpret systems that change with time, and some in the mechanisms they provide to reason through time. A popular example is the Linear Temporal Logic, where time is modelled as a linear order with a clear beginning, and systems that change with time are tracked using classical propositional logic. Other logics have modelled branching time, concurrent systems, and other complex graph structures.

These logics have found applications in many domains, from the formal verification of the behaviour of computer programs to database management systems and even to planning problems in Artificial Intelligence. A part of the reason for the ubiquity of temporal logics is the combination of their attractive expressiveness and complexity properties. The satisfiability of linear-temporal logic, for example, is PSPACE-complete (see \cite{vardiLTL}), which is a significant improvement from the non-elementary complexity of the same problem in the similarly expressive first-order monadic logic of order.

The separation property, invented by Dov Gabbay in \cite{Gabbay1981}, is a strangely influential consequence of the design of popular temporal languages. Simply put, it requires all formulas in the language to be equivalent to a variant made up of formulas purely concerned with certain \textit{regions} of time. Surprisingly, this property is linked to expressive completeness: a sufficiently expressive temporal logic with the separation property can express any first-order specification. In \cref{sec:linear-time}, we will detail the separation property over linear time and how it implies functional completeness.

% Separation has many interesting applications beyond expressive completeness. Gabbay describes one fascinating use-case in \cite{DecPastImpFuture89}. Here, he notes that while general formulas in the temporal logic of $U$ and $S$ (which we describe in \cref{sec:preliminaries}) are \textit{declarative} (i.e., they \textit{declare} correct behaviour), formulas purely concerned with the future can be viewed as instructions (to produce correct behaviour) in an imperative programming language. This, in addition to the separation property, allows us to write every statement in the logic as a conjunction of requirements that (1) inspect the past to see if it satisfies a declarative property, and if the past is correct (2) require future behaviour to be of a certain form. % NOTE: Unfortunately, I probably shouldn't describe this paper entirely here.

Separation has many interesting applications beyond expressive completeness. A beautiful one can be found in \cite{DecPastImpFuture89}, which describes how a temporal language can simultaneously be \textit{declarative} (i.e., specifies correct behaviour) and \textit{imperative} (i.e., provides instructions to achieve correct behaviour). Another use-case, described in \cite{Lichtenstein1985TheGO}, allows formulas to be written as a boolean combination of safety and liveness properties. A more thorough exposition of the applications of separation can be found in \cite{GabbayBirthday05}.

As we earlier implied, temporal languages have been studied for a variety of models of time. A particularly interesting and useful class of temporal logics model time as \textit{ordered trees}. The usefulness of these languages stems directly from the fact that many natural structures in computer science (such as nested words, see \cite{alur2009}) can be encoded as ordered trees. In \cite{marx2005conditional}, Marx describes \textit{Conditional XPath}, a language capable of expressing any first-order property over finite ordered trees. He simplifies this language to its core in \cite{xpathComplete}, and proposes a separation property for it.

Unfortunately, the proof Marx employs for his separation property is incorrect. The mistake lies in an unnamed lemma, and has been commented on in \cite{BeJe07, nwtl}. Further attempts to prove a separation result have been made in \cite{BeCl16}, with mostly negative results.

In this thesis, we explore results around the separation of Conditional XPath over ordered trees. We note Marx's mistakes, and show that his arguments in \cite{xpathComplete} naturally lead to a \textit{partial} separation property, whereby a subset of formulas can be separated. We also believe that certain simple formulas \textit{cannot} be separated; through the use of EF games adapted from \cite{EtWi00}, we show a result that implies that separation of such a formula is unlikely. Separately, we also justify Marx's choice of regions by showing that a more desirable set of regions cannot yield separation.

The structure of this document is as follows. In \cref{sec:preliminaries}, we discuss basic notions regarding temporal languages. In \cref{sec:linear-time}, we provide a (mostly) self-contained exposition of Gabbay's proof of separation over linear time (see \cite{DecPastImpFuture89, gabbay1994}). We discuss our main results in \cref{sec:ordered-trees}.

\section{Preliminaries}
\label{sec:preliminaries}

Before discussing separation, we define some standard notions. A flow of time is simply a non-empty set $T$ partially ordered by the binary relation $<$. We symbolically refer to these flows by the pair $(T, <)$. Examples include $(\mathbb{N}, <)$ and $(\mathbb{R}, <)$ with their natural ordering, unordered trees with the descendant relation, and Mazurkiewicz traces. We will consider the truth values of propositions (from a fixed set $\mathcal{P}$) at points on these flows.

The first-order vocabulary over these structures contains the ordering relation $<$ and a collection of \textit{monadic} relations $Q_1, Q_2, \cdots$ that match the propositions $q_1, q_2, \cdots$ in $\mathcal{P}$. An assignment $h$ of atoms in a time flow $(T, <)$ assigns to each $Q_i$ a subset of $T$ where the atom $q_i$ is true. Augmented with the assignment, the triplet $(T, <, h)$ is called a \textit{temporal structure}. First-order formulas are evaluated over these structures in the usual way. In this discussion, we pay special attention to first-order formulas with a single free-variable; they quite naturally mirror temporal formulas.

Instead of free variables and quantification, temporal languages employ \textit{connectives} to reason through time. Popular connectives include $F$, $P$, $G$, $H$, $U$, and $S$, known as \textit{future}, \textit{past}, \textit{globally}, \textit{history}, \textit{until} and \textit{since} respectively. In this paper, we will limit our discussion to connectives that are definable by monadic first-order formulas.

Temporal formulas are evaluated at points in time. In a temporal structure $\mathcal{M} = (T, <, h)$, atoms are evaluated as
\begin{equation*}
    \mathcal{M}, t \vDash p \Longleftrightarrow (T, <, h[x \mapsto t]) \vDash p(x) \Longleftrightarrow t \in h(p)\\
\end{equation*}
As per the standard notation, the assignment $h[x \mapsto t]$ assigns the time point $t$ to the first-order variable $x$. To simplify the presentation, we use $\mathcal{M}, t \vDash \varphi(t)$ to mean $(T, <, h[x \mapsto t]) \vDash \varphi(x)$.

For a generic connective $\sharp$ of arity $n$, let $\varphi_\sharp(t, X_1, \cdots X_n)$ be the monadic first-order formula defining it. Here, $t$ is the point in time that the connective is evaluated at, and the $X_i$ are monadic (second-order) variables. These variables expect a single-variable first-order formula, as shown below
\begin{equation*}
    \mathcal{M}, t \vDash \sharp(A_1, \cdots A_n) \Longleftrightarrow \mathcal{M}, t \vDash \varphi_\sharp(t, \alpha_{A_1}, \cdots \alpha_{A_n})
\end{equation*}
Here, $A_i$ are temporal formulas and $\alpha_{A_i}$ are their first-order translations. Notably, $\varphi_\sharp$ can only quantify over elements in the domain $T$; it cannot use second order quantifiers.

We illustrate this behaviour with an example. The connective $F$ is defined by the formula
\begin{equation*}
    \varphi_F(t, X) \triangleq \exists x.\, (t < x) \land X(x)
\end{equation*}
Hence, we have
\begin{equation*}
    \mathcal{M}, t \vDash F p \Longleftrightarrow \mathcal{M}, t \vDash \exists y.\, (t < y) \land p(y)
\end{equation*}
We similarly define the other main connectives
\begin{equation*}
    \begin{aligned}
        \varphi_P(t, X) &\triangleq \exists x.\, (x < t) \land X(x)\\
        \varphi_G(t, X) &\triangleq \forall x.\, (t < x) \land X(x)\\
        \varphi_H(t, X) &\triangleq \forall x.\, (x < t) \land X(x)\\
        \varphi_U(t, X_1, X_2) &\triangleq \exists x.\, \left[ \left( t < x \right) \land X_1(x) \land \forall y \left( \left( t < y < x \right) \to X_2(y) \right) \right]\\
        \varphi_S(t, X_1, X_2) &\triangleq \exists x.\, \left[ \left( x < t \right) \land X_1(x) \land \forall y \left( \left( x < y < t \right) \to X_2(y) \right) \right]\\
    \end{aligned}
\end{equation*}
Note that, unlike the typical definition of $U$, $\varphi_U$ doesnâ€™t rely on the present point $t$. Such an until is referred to in the literature by either the \textit{strict} until (see \cite{gastinStrictUntil06}) or the \textit{strong} until (see \cite{BeCl16}). This particular behaviour makes observing separation much easier.

\begin{definition}[Expressive Completeness]
    \label{expressive-completeness-definition}
    A temporal language is \textbf{first-order expressively complete} over a class of time flows \textit{iff} there exists a temporal formula $A$ for any first-order formula with one free variable $\varphi(t)$ such that
\begin{equation*}
    \mathcal{M}, t \vDash A \Longleftrightarrow \mathcal{M}[x \mapsto t] \vDash \varphi(x)
\end{equation*}
    for any flow $\mathcal{M}$ in the class.
\end{definition}
On a related note, a flow of time $(T, <)$ is termed to be expressively complete if there exists an expressively complete temporal language over it.

\section{Linear Flows}
\label{sec:linear-time}

In \cite{gabbay1994}, Gabbay showed how the temporal language $\mathbf{L}$ with the strict until $U$ and since $S$ connectives satisfies the separation property over the integer time flow $(\mathbb{Z}, <)$.

To discuss this further, we need the notion of \textit{regions} and \textit{pure formulas}. Informally, the flow of time $(T, <)$ is partitioned into a set of regions. The positions of these regions depends on the position of the time point $t$ where the temporal formula is being evaluated. For linear flows, Gabbay selected three regions:
\begin{itemize}
    \item The \textit{past} of $t$, formally defined as $\{ x \mid x \in \mathbb{Z} \land x < t\}$.
    \item The \textit{present}, which is simply $\{ t \}$.
    \item The \textit{future} of $t$, which naturally is $\{x \mid x \in \mathbb{Z} \land t < x\}$
\end{itemize}
Note that these regions are disjoint, and that the union of these regions produces the entire flow. Also, notice that these regions are first-order definable.

\begin{figure}
    \centering
    \tikzfig{separation-linear}
    \caption[]{Regions for linear separation. The present is black, the past is \textcolor{OliveGreen}{green}, and the future is \textcolor{blue}{blue}.}
    \label{fig:linear-separation-regions}
\end{figure}

% TODO: Consider writing these in \begin{definition}
Now, we define \textit{pure formulas}. For any flow $(T, <)$, we denote two assignments $h$ and $h'$ to be in \textit{agreement} over a region $R \subset T$ \textit{iff} for any atom $q \in \mathcal{P}$ and any point $s \in R$,
\begin{equation*}
    s \in h(q) \Longleftrightarrow s \in h'(q)
\end{equation*}
Now, call a temporal formula $A$ \textit{pure} with respect to a region $R$ \textit{iff} for any two assignments $h$ and $h'$ that agree on $R$,
\begin{equation*}
    (T, <, h), t \vDash A \Longleftrightarrow (T, <, h'), t \vDash A
\end{equation*}
In other words, $A$ is true on $h'$ \textit{iff} $A$ is true on $h$. We use the terms \textit{pure past}, \textit{pure present}, or \textit{pure future} to denote pure formulas in the past, present, and future regions respectively.

It's easy to see that formulas that don't use the $S$ and $U$ connectives are pure-present. In a similar vein, formulas that are rooted by a $S$ connective and don't use $S$ connectives are pure-past. We formalize this understanding using the notion of \textit{syntactically pure} formulas. To simplify presentation, we refer to formulas rooted by a $U$ (or an $S$) as $U$-formulas (or $S$-formulas, respectively).
\begin{definition}
    A temporal formula $\varphi$ in the temporal language of $S$ and $U$ is
    \begin{enumerate}
        \item syntactically pure-present iff it doesn't use the $S$ and $U$ connectives.
        \item syntactically pure-past iff it is a boolean combination of $S$-formulas that don't use the $U$ connective.
        \item syntactically pure-future iff it is a boolean combination of $U$-formulas that don't use the $S$ connective.
    \end{enumerate}
\end{definition}

Finally, call a formula $A$ \textbf{separated} if it is a boolean combination of pure formulas. Now, we can state the separation property
\begin{theorem}[Separation Property for linear flows]
    \label{theorem:separation-property-linear-time}
    Every temporal formula $A$ in the language of $S$ and $U$ over linear time can be equivalently represented by a separated formula.
\end{theorem}

The proof of this theorem is quite involved, and is presented in full detail in \cite{gabbay1994}. In the next few sections, I'll give a high-level overview of Gabbay et. al.'s scheme. To mirror their notation, I'll write $U$ formulas as $U(p, q)$ instead of $q \,\mathcal{U}\, p$.

\subsection{Separating $S$ and $U$ over linear time}

As a reminder, we restate the definitions of $U$ and $S$
\begin{equation*}
    \begin{aligned}
        \mathcal{M}, t \vDash U(p, q) &\Longleftrightarrow \mathcal{M}, t \vDash \exists x.\, (t < x) \land p(x) \land \forall y \left( t < y < x \to q\left( y \right) \right)\\
        \mathcal{M}, t \vDash S(p, q) &\Longleftrightarrow \mathcal{M}, t \vDash \exists x.\, (x < t) \land p(x) \land \forall y \left( x < y < t \to q\left( y \right) \right)
    \end{aligned}
\end{equation*}
For convenience, we refer to the left condition ($p$) in $U(p, q)$ as the \textit{target} condition and the right condition ($q$) as the \textit{path} condition. Observe that, over linear time, a formula composed only of $U$s is a pure future formula, a formula composed of $S$s is a pure past formula. The task, therefore, is to transform formulas with both $U$s and $S$es.

Over the integer time flow $(\mathbb{Z}, <)$, these connectives naturally possess the following properties
\begin{equation}
    \label{eq:or-and-S-U}
    \begin{aligned}
        U(\alpha \lor \beta, \gamma) &\equiv U(\alpha, \gamma) \lor U(\beta, \gamma)\\
        U(\alpha, \beta \land \gamma) &\equiv U(\alpha, \beta) \land U(\alpha, \gamma)
    \end{aligned}
\end{equation}
In addition, their negations can be usefully rewritten as
\begin{equation*}
    \begin{aligned}
        \lnot U(\alpha, \beta) &\equiv G(\lnot \alpha) \lor U(\lnot \alpha \land \lnot \beta, \lnot \alpha) \\
        \lnot S(\alpha, \beta) &\equiv H(\lnot \alpha) \lor S(\lnot \alpha \land \lnot \beta, \lnot \alpha)
    \end{aligned}
\end{equation*}
where the semantics of $G$ and $H$ are
\begin{equation*}
    \begin{aligned}
        \mathcal{M}, t \vDash G(\alpha) &\Longleftrightarrow \mathcal{M}, t \vDash \forall t'.\; t' > t \to \varphi_\alpha(t') \\
        \mathcal{M}, t \vDash H(\alpha) &\Longleftrightarrow \mathcal{M}, t \vDash \forall t'.\; t' < t \to \varphi_\alpha(t')
    \end{aligned}
\end{equation*}
Here, $\varphi_\alpha$ is the first-order translation of $\alpha$.

Our strategy involves \textit{pulling-out} $U$s from inside $S$ and vice versa. We accomplish this by writing all temporal formulas in a standard notation, and then applying a sequence of \textit{elimination} rules. In the next section, we describe these rules.

\subsubsection{Eliminations}
\label{sec:eliminations-linear}

Let $\alpha$, $\beta$, $\varphi$ and $\psi$ be boolean combinations of propositional atoms. In the following subsections, we pull out a $U(\varphi, \psi)$ from inside a $S$ under a variety of minimal configurations. In later sections, we show that these configurations suffice.

\paragraph*{$S(\alpha \land U(\varphi, \psi), \beta)$}
This formula requires $U(\varphi, \psi)$ to be true at a point $t'$ in the past of $t$. This in turn implies $\varphi$ at some point $t''$ ahead of $t'$. This naturally breaks down into three cases: $t'' > t$, $t'' = t$, and $t' < t'' < t$. The translation is
\begin{equation*}
    \begin{aligned}
        &S(\varphi \land \beta \land S(\alpha, \psi \land \beta), \beta)\\
        \lor \quad &\left(S(\alpha, \psi \land \beta) \land \left(\varphi \lor \left(\psi \land U(\varphi, \psi) \right) \right) \right)
    \end{aligned}
\end{equation*}

\paragraph*{$S(\alpha \land \lnot U(\varphi, \psi), \beta)$}
In this case, we immediately rewrite $\lnot U(\varphi, \psi)$ as $G(\lnot \alpha) \lor U(\lnot \alpha \land \lnot \beta, \lnot \alpha)$. This gives us
\begin{equation*}
    \begin{aligned}
        S(\alpha \land \lnot &U(\varphi, \psi), \beta) \equiv\\
        &S(\alpha \land G(\lnot \varphi), \beta) \\
        \lor \quad &S(\alpha \land U(\lnot \varphi \land \lnot \psi, \lnot \varphi), \beta)
    \end{aligned}
\end{equation*}
where each individual case can be translated using the ideas used to rewrite $S(\alpha \land U(\varphi, \psi), \beta)$.

\paragraph*{$S(\alpha, U(\varphi, \psi))$}
It's instructive to recognize how $S(\alpha, U(\varphi, \psi))$ could be translated. Unlike the previous cases, the Until fragment needs to be true at each point in the path to $\alpha$. This could involve multiple segments in this path where $\psi$ is true till $\varphi$ is true. Wonderfully, this is \textit{indistinguishable} from the case where, at each point in the path, either $\varphi$ or $\psi$ is true. This formula is translated to % TODO: Fix this formula
\begin{equation*}
    \begin{aligned}
        &S(\alpha, \bot) \\
        \lor \quad &S(\alpha, \varphi \lor \psi) \land \left[ \varphi \lor \left(\psi \land U\left(\varphi, \psi \right) \right) \right] \\
    \end{aligned}
\end{equation*}
Here, $S(\alpha, \bot)$ can only be true if $\alpha$ is true at the previous point. Otherwise, we'll need $U(\varphi, \psi)$ to be satisfied at the previous location, hence the $\varphi \lor (\psi \land U(\varphi, \psi))$ at the present. At each point $t'$ in the path to $\alpha$, if $t' + 1 \vDash \varphi$, $t' \vDash U(\varphi, \psi)$. Otherwise, $t' + 1 \vDash \psi$. At this point, we can use an inductive argument, starting from the previous point, to prove the correctness of this translation.

\paragraph*{$S(\alpha, \beta \lor U(\varphi, \psi))$}

% I had some trouble extending this analysis to translate $S(\alpha, \beta \lor U(\varphi, \psi))$. Gabbay's presentation is confusing, as he provides an unnecessarily complicated translation for this, but later presents a cleverer translation embedded in his translation of $S(\alpha \land U(\varphi, \psi), \beta \lor U(\varphi, \psi))$, a more complex formula. Gratifyingly, this translation uses elements of my translation of $S(\alpha, U(\varphi, \psi))$.

The idea is to attempt to enforce $U(\varphi, \psi)$ at each point in the path \textit{iff} we can detect an earlier point in the path which needed to satisfy it. A simple way to detect these points is to look for the moment where $\lnot \beta$ was true, and check whether, along the way to that point, $\lnot \varphi$ was true at each step. Accordingly, $S(\lnot \beta \land \lnot \alpha, \lnot \varphi \land \lnot \alpha)$ does the trick. Here, the $\lnot \alpha$ is to ensure that we specifically look for points in the future of $\alpha$, the leftmost point in our consideration.

It's important to recognize that we are capable of recognizing such points at each step of the path to $\alpha$. This means that, if we recognized such a point that's 3 steps away, we recognized it at 2 and 1 step away too. This allows us a simple fix: $S(\lnot \beta, \lnot \varphi \land \lnot \alpha) \to \varphi \lor \psi$. If $\varphi$ was true, we will not see this point in our next search. Otherwise, $\psi$ would be true, allowing for the possibility of enforcement in the future.

The overall translation now is
\begin{equation*}
    \begin{aligned}
    S(\alpha, \lnot \alpha \land (S(\lnot \beta \land \lnot \alpha, \lnot \varphi \land \lnot \alpha) \to \varphi \lor \psi)) \\
    \quad \land \quad S(\lnot \beta \land \lnot \alpha, \lnot \varphi \land \lnot \alpha) \to (\varphi \lor (\psi \land U(\varphi, \psi)))
    \end{aligned}
\end{equation*}

\paragraph*{$S(\alpha, \beta \lor \lnot U(\varphi, \psi))$}
This case is very similar to the previous case. The points we search for must be in danger of satisfying $U(\varphi, \psi)$; hence, we look for $S(\lnot \beta \land \lnot \alpha, \psi \land \lnot \alpha)$. We fix these points by requiring $\varphi$ to be false. In the worst-case, we've dragged on the possible \textit{until} to the present, at which point we can extinguish all hope. This gives us the overall translation:
\begin{equation*}
    \begin{aligned}
    S(\alpha, \lnot \alpha \land (S(\lnot \beta \land \lnot \alpha, \psi \land \lnot \alpha) \to \not \varphi)) \\
    \quad \land \quad S(\lnot \beta \land \lnot \alpha, \psi \land \lnot \alpha) \to ((\lnot \psi \land \lnot \varphi) \lor (\lnot U(\varphi, \psi)))
    \end{aligned}
\end{equation*}

\paragraph*{$S(\alpha \land U(\varphi,\psi), \beta \lor U(\varphi, \psi))$}
This is a neat combination of $S(\alpha \land U(\varphi, \psi), \beta)$ and $S(\alpha, \beta \lor U(\varphi, \psi))$. The translation is simple. \textit{I believe Gabbay made a typo in this particular example. \cite{xpathComplete} mentions this.}
\begin{equation*}
    \begin{aligned}
        \quad S(\alpha, \psi) \land (\varphi \lor (\psi \land U(\varphi, \psi))) \\
        \lor \quad \quad S(\varphi \land S(\alpha, \psi), S(\lnot \beta, \lnot \varphi) \to \varphi \lor \psi)\\
        \quad \land \quad S(\lnot \beta, \lnot \varphi) \to (\varphi \lor (\psi \land U(\varphi, \psi)))
    \end{aligned}
\end{equation*}

\subsubsection{Putting it all together}

The eliminations presented in the previous section lend credence to the idea of separation. Amazingly, Gabbay presents a neat induction scheme that builds on these rules to separate \textit{any} temporal formula in the language. In this section, we present an overview of his arguments (presented in more detail in \cite{gabbay1994}).

\begin{lemma}
\label{lemma:separation-linear-step1}
    Let $\varphi$ and $\psi$ be pure-present formulas and $\alpha$ and $\beta$ be formulas such that the only appearance of a $U$ in either of them is $U(\varphi, \psi)$, and that $U$ isn't nested inside a $S$. Then $S(\alpha, \beta)$ can be written as a syntactically separated formula where the only appearance of $U$ is $U(\varphi, \psi)$.
\end{lemma}
\begin{proof}
    We start by writing $\alpha$ and $\beta$ in their conjunctive and disjunctive normal forms respectively. During this transformation, we treat all top-level instances of $U$ and $S$ in them as atomic propositions. This gives us
    \begin{equation*}
        \begin{aligned}
            \alpha &\equiv \bigvee_i \left( \alpha_{i, 1} \land \alpha_{i, 2} \land \cdots \land \alpha_{i, m_i} \right)\\
            \beta &\equiv \bigwedge_j \left( \beta_{j, 1} \lor \beta_{j, 2} \lor \cdots \lor \beta_{j, n_j} \right)
        \end{aligned}
    \end{equation*}
    Here, the literals $\alpha_{i, k}$ and $\beta_{i, k}$ are composed of propositional atoms, $S$ formulas, and $U(\varphi, \psi)$. We use the above and equation \eqref{eq:or-and-S-U} to write $S(\alpha, \beta)$ as
    \begin{equation}
        \label{eq:dnf-form-S-alpha-beta}
        \begin{aligned}
            S(\alpha, \beta) &\longmapsto S\left(\bigvee_i (\alpha_{i, 1} \land \cdots \land \alpha_{i, m_i}), \beta\right)\\
            &\longmapsto \bigvee_i S(\alpha_{i, 1} \land \cdots \land \alpha_{i, m_i}, \beta)\\
            &\longmapsto \bigvee_i S\left(\alpha_{i, 1} \land \cdots \land \alpha_{i, m_i}, \bigwedge_j \left( \beta_{j, 1} \lor \cdots \lor \beta_{j, n_i} \right) \right)\\
            &\longmapsto \bigvee_i \bigwedge_j S\left(\alpha_{i, 1} \land \cdots \land \alpha_{i, m_i}, \beta_{j, 1} \lor \cdots \lor \beta_{j, n_i} \right)
        \end{aligned}
    \end{equation}
    In the resulting formula, the target of each top-level $S$ is a conjunction of literals, and the path condition is a disjunction of literals. Notably, if $U(\varphi, \psi)$ doesn't appear in the target and the path of a top-level $S$ formula, that subformula is a pure-past formula.

    Hence, we focus our attention on the top-level $S$ formulas containing $U(\varphi, \psi)$. In one such formula, let $\alpha'$ be the conjunction of all literals in the target that aren't $U(\varphi, \psi)$ or its negation. Similarly, let $\beta'$ be the disjunction of all literals in the path that aren't $U(\varphi, \psi)$ or its negation. This lets us write that formula as one of the following
    \begin{equation*}
        \begin{aligned}
            &S(\alpha' \land \pm U(\varphi, \psi), \beta')\\
            &S(\alpha', \beta' \lor \pm U(\varphi, \psi))\\
            &S(\alpha' \land \pm U(\varphi, \psi), \beta' \lor \pm U(\varphi, \psi))\\
        \end{aligned}
    \end{equation*}
    Clearly, the eliminations we explored in the previous section can separate this formula! Additionally, note that the only $U$ formula in the RHS of the eliminations is $U(\varphi, \psi)$, satisfying the condition specified in the beginning of the lemma.

    Applying these elimination rules to each top-level $S$ containing a $U(\varphi, \psi)$ produces a separated formula equivalent to $S(\varphi, \psi)$. This completes the proof.
\end{proof}

The second step of the induction scheme is to consider cases where $U(\varphi, \psi)$ is nested under multiple levels of $S$.
\begin{lemma}
\label{lemma:separation-linear-step2}
    Let $\varphi$ and $\psi$ be pure-present formulas, and let $\gamma$ be a formula such that the only appearance of a $U$ in $\alpha$ is $U(\varphi, \psi)$. Then, $\gamma$ can be written as a syntactically separated formula where the only appearance of a $U$ is $U(\varphi, \psi)$.
\end{lemma}
\begin{proof}
    We show this lemma by inducting on the pair $(n_1, n_2)$, where $n_1$ is the maximum number of nested $S$es above a $U(\varphi, \psi)$ and $n_2$ is the number of $U(\varphi, \psi)$ nested inside $n_1$ $S$s.
    \begin{description}
        \item[Base case.] Here, $n_1 = 0$, and $\gamma$ is already separated.
        \item[Induction step.] Pick the most deeply nested subformula $S(\alpha, \beta)$ of $\gamma$ such that all instances of $U(\varphi, \psi)$ in $\alpha$ and $\beta$ are not nested inside a $S$. Applying lemma \ref{lemma:separation-linear-step1} to $S(\alpha, \beta)$ strictly reduces $(n_1, n_2)$, allowing us to use the induction hypothesis. Remember, lemma \ref{lemma:separation-linear-step1} only generates formulas where then only appearance of $U$ is $U(\varphi, \psi)$, which is required to use the induction hypothesis.
    \end{description}
    This completes the proof.
\end{proof}
The next step generalizes this approach to different (basic) until subformulas.
\begin{lemma}
\label{lemma:separation-linear-step3}
    Let $\varphi_1, \varphi_2, \ldots \varphi_n$ and $\psi_1, \psi_2, \ldots \psi_n$ be pure present formulas and $\gamma$ be a formula such that all appearances of $U$ in $\gamma$ are of the form $U(\varphi_i, \psi_i)$ for some $i \in \{1, 2, \ldots n\}$. Then, $\gamma$ can be written as a syntactically separated formula.
\end{lemma}
\begin{proof}
    Predictably, we induct on $n$.
    \begin{description}
        \item[Base case.] This is $n = 1$, identical to lemma \ref{lemma:separation-linear-step2}.
        \item[Induction case.] Introduce new propositional atoms $p_1, p_2, \ldots p_{n-1}$. For each $i \in \{1, \ldots n - 1\}$, replace each occurrence of $U(\varphi_i, \psi_i)$ in $\gamma$ with $p_i$ to produce $\gamma'$. We can apply lemma \ref{lemma:separation-linear-step2} to $\gamma'$ to produce its separated equivalent, $\gamma''$. Replace each instance of $p_i$ in $\gamma''$ with $U(\varphi_i, \psi_i)$ to produce $\gamma'''$. Finally, apply the induction hypothesis on $\gamma'''$ to separate $\gamma$.
    \end{description}
    This proves the lemma.
    \begin{remark*}
        It isn't difficult to see that we cannot use lemma \ref{lemma:separation-linear-step2} if we introduce a single atom $p_n$ to represent $U(\varphi_n, \psi_n)$. Introducing more atoms is essential to the overall induction structure.
    \end{remark*}
\end{proof}
We can now finally consider the case of nested $U$s.
\begin{lemma}
    \label{lemma:separation-linear-step4}
    Let $\gamma$ be a formula that doesn't contain $S$s nested inside a $U$. Then, $\gamma$ can be separated.
\end{lemma}
\begin{proof}
    We cleverly induct on the maximum nesting depths of $U$s under a $S$. Let $n$ be the maximum $U$-nesting depth of $\gamma$.
    \begin{description}
        \item[Base case.] This is $n = 1$, which is lemma \ref{lemma:separation-linear-step3}.
        \item[Induction step.] Suppose there are $m$ subformulas rooted at a $U$ that aren't under a $U$ and are under an $S$. Introduce $2m$ atoms $\{p_1, \ldots p_{2m}\}$ and replace the target and path conditions of these $m$ subformulas with these atoms. This produces a new formula $\gamma'$ that is amenable to lemma \ref{lemma:separation-linear-step3}. Applying the lemma produces a separated formula $\gamma''$ that uses the atoms $\{p_1, \ldots p_{2m}\}$. These atoms may appear under a $S$ in the separated formula $\gamma''$. Now, replace each of these atoms by the target/path condition they substituted earlier. This produces $\gamma'''$, a formula with the maximum $U$-nesting depth under a $S$ strictly $< n$. Applying the induction hypothesis on $\gamma'''$ proves this lemma.
    \end{description}
    \begin{remark*}
        We don't need to consider the value $m$ in our induction hypothesis, as required in the proof of lemma \ref{lemma:separation-linear-step2}.
    \end{remark*}
\end{proof}
Before we finally prove the separation theorem, notice that, since $U$ and $S$ are duals of each other, the eliminations in section \ref{sec:eliminations-linear} and lemmas \ref{lemma:separation-linear-step1}, \ref{lemma:separation-linear-step2}, \ref{lemma:separation-linear-step3} and \ref{lemma:separation-linear-step4} hold when the $U$ and $S$ are swapped.
%TODO: Understand and implement Theorem-Restate here
\begin{theorem}[Separation Property for Linear Time]
    \label{theorem:separation-linear-final}
    Any formula $\gamma$ that uses $S$ and $U$ can be separated.
\end{theorem}
\begin{proof}
    We induct over the \textit{junction depth} of the input formula. Define this depth as follows.
    \begin{definition}[Junction Depth]
        The junction depth of a temporal formula $\gamma$ is the length of the longest sequence of subformulas $\alpha_1, \alpha_2, \ldots \alpha_n$ of $\gamma$ such that
        \begin{enumerate}
            \item The root of all $\alpha_i$ is either a $U$ or a $S$.
            \item $\alpha_{i+1}$ is a subformula of $\alpha_i$.
            \item If $\alpha_i$ is rooted by a $U$ (or a $S$), then $\alpha_{i+1}$ is rooted by a $S$ (or a $U$, respectively).
            \item There is no subformula $\beta$ of $\gamma$ such that \label{item:junction-depth-extra-condition}
                \begin{enumerate}
                    \item $\beta$ is a strict subformula of $\alpha_i$.
                    \item $\alpha_{i+1}$ is a strict subformula of $\beta$.
                    \item $\beta$ and $\alpha_{i+1}$ are rooted by the same connective.
                \end{enumerate}
        \end{enumerate}
    \end{definition}
    Note that condition \ref{item:junction-depth-extra-condition} isn't necessary to compute the junction depth. However, I will use it in my proof.

    As an illustration, observe that the junction depth of the formula $U \left(a, S\left( U(c, d), U(e, f) \right) \right)$ is 3, and there are two possible sequences:
    \begin{itemize}
        \item $U \left(a, S\left( U(c, d), U(e, f) \right) \right), S(U(c, d), U(e, f)), U(c, d)$.
        \item $U \left(a, S\left( U(c, d), U(e, f) \right) \right), S(U(c, d), U(e, f)), U(e, f)$.
    \end{itemize}

    Let the junction depth of $\gamma$ be $n$.
    \begin{description}
        \item[Base case 1: $n = 1$.] The formula is already separated.
        \item[Base case 2: $n = 2$.] In this case, apply lemma \ref{lemma:separation-linear-step4} to separate $\gamma$.
        \item[Induction step: $n \geq 3$.] Let there be $m$ sequences of subformulas that witness the junction depth $n$. Form a set $A$ of all subformulas at position 3 of these $m$ sequences; the size of $A$ can be less than $m$. Note that condition \ref{item:junction-depth-extra-condition} makes these subformulas maximal; i.e., no formula in $A$ is a subformula of another. This maximality allows us to substitute each formula in $A$ with a newly introduced atom from the set $\{p_1, \ldots p_{|A|}\}$.

        Call the resulting formula $\gamma'$. It isn't difficult to argue that this formula has a junction depth of strictly $< n$, allowing us to apply the induction hypothesis. This produces a separated formula $\gamma''$ with $|A|$ new atoms. Substitute the subformulas in $A$ at the corresponding atoms in $\gamma''$ to produce $\gamma'''$.

        Now, all subformulas in $A$ have a junction depth of $n - 2$. If all of these appear in the pure-present segment of $\gamma''$, the new junction depth of $\gamma'''$ grows to at-most $n - 2$. Similarly, if one of these substitutions occurs inside a pure-past / pure-future segment of $\gamma''$, the junction depth grows to at-most $n - 1$. This allows us to apply the induction hypothesis again, producing the fully separated formula $\gamma'''$.
    \end{description}
    This proves the separation theorem over linear time.
\end{proof}

\subsection{Implying Expressive-Completeness}

In this section, we provide an overview of the proof that \cref{theorem:separation-linear-final} implies expressive completeness. We start by proving an auxiliary result.
\begin{lemma}
    \label{lemma:pulling-out-present-lemma}
    Every formula of $m + 1$ variables $\varphi(t, x_1, \ldots, x_m)$ in the first-order monadic logic of order with the monadic relations $\{Q_1, Q_2, \cdots Q_k\}$ can be written in the form
    \begin{equation*}
        \bigvee_i \beta_i(t) \land \alpha_i(t, x_1, \ldots, x_m)
    \end{equation*}
    for some $i$ where $t, x_1, \ldots, x_m$ are the $m + 1$ free variables in $\varphi$, $\beta_i(t)$ is quantifier free, and no atomic formula of the form $Q(t)$ appears in $\alpha_i(t, x)$ for any $Q \in \{Q_1, \ldots Q_k\}$.
\end{lemma}
\begin{proof}
    We show this lemma by inducting on the quantifier depth of $\varphi$.
    \begin{description}
        \item[Base case.] $\varphi$ is quantifier free. In this case, it's easy to see that the DNF form of $\varphi$ is what we need.
        \item[Induction case.] Suppose the lemma holds for all formulas of quantifier depth $< n$, and $\varphi$ has quantifier depth $n$. Begin by writing all subformulas of the form $\forall y.\, \alpha$ as $\lnot \exists y.\, \lnot \alpha$. After this transformation, $\varphi$ is a boolean combination of atomic formulas of the form $Q(y)$, $y < z$ ($y, z \in \{t, x_1, \ldots, x_m\}$) and quantified subformulas $\exists y.\, \psi$ for some bound variable $y$.

        Observe that each $\psi$ in the previous form has a quantifier depth of $n-1$. Applying the induction hypothesis on $\psi$ gives us an equivalent formula
        \begin{equation*}
            \psi \equiv \bigvee_i \beta_i(t) \land \alpha_i(t, x_1, \ldots, x_m, y)
        \end{equation*}
        Now, we simply push the existential quantifier deeper inside $\exists y.\, \psi$:
        \begin{equation*}
            \begin{aligned}
                \exists y.\, \psi &\longmapsto \exists y.\, \left( \bigvee_i \beta_i(t) \land \alpha_i(t, x_1, \ldots, x_m, y) \right)\\
                &\longmapsto \bigvee_i \exists y.\, \left( \beta_i(t) \land \alpha_i(t, x_1, \ldots, x_m, y) \right)\\
                &\longmapsto \bigvee_i \beta_i(t) \land \exists y.\, \alpha_i(t, x_1, \ldots, x_m, y)\\
            \end{aligned}
        \end{equation*}
        where all $\beta_i(t)$ remain quantifier free and no $Q(t)$ appears in any $\alpha_i$.

        After writing each $\exists y.\, \psi$ in this form, $\varphi$ becomes a boolean combination of $Q(y)$, $y < z$ (again, $y, z \in \{t, x_1, \ldots, x_m\}$), and $\exists y.\, \alpha(t, x_1, \ldots x_m, y)$. We can now take the DNF form of this formula by treating each $\exists y.\, \alpha$ as though it were an atom. It isn't difficult to see that this final formula is what we need, proving the lemma.
    \end{description}
\end{proof}
Notice that the primary arguments in the proof of \cref{lemma:pulling-out-present-lemma} are quite general. These arguments can be reused to show similar results in the case of more complex first-order relational vocabularies. For now, consider a useful corollary.
\begin{corollary}
    \label{corollary:separate-present-form-fomlo}
    Every single-variable formula $\varphi(t)$ in the first-order monadic order of logic can be written in the form
    \begin{equation*}
        \bigvee_i \left( \beta_i(t) \land \bigwedge_j \left( \pm \exists y.\, \alpha_{i, j}\left(t, y\right) \right) \right)
    \end{equation*}
    where $\beta_i(t)$ is quantifier-free and $Q(t)$ doesn't appear in $\alpha$.
\end{corollary}
\begin{proof}
    This can easily be observed by realizing that, in the case of a single-variable formula, all $\alpha_i$ in \cref{lemma:pulling-out-present-lemma} must be boolean combination of formulas of the form $\exists y.\, \psi$. Considering each of these as atoms and writing the DNF form of the resulting formula gives us what we need.
\end{proof}
Finally, we consider the separation theorem.
\begin{theorem}[Separation Theorem for Linear Time]
    \label{theorem:separation-theorem-linear-time}
    Every single-variable formula $\varphi(t)$ of the first-order monadic logic of order with the monadic relations $\{Q_1, \ldots, Q_m\}$ evaluated over linear time can be expressed by a formula in the temporal logic of the strict $S$ and $U$ over linear flows of time.
\end{theorem}
\begin{proof}
    Before we begin the proof, note that, as per the established norms, the temporal language has access to the monadic relations $\{Q_1, \ldots, Q_m\}$ through the use of propositional atoms $\{q_1, \ldots, q_m\}$.

    We induct on the quantifier depth of $\varphi$.
    \begin{description} %TODO: Figure out how to add indentation to paragraphs within description
        \item[Base case.] $\varphi(t)$ is quantifier free. Construct a temporal formula by replacing all instances of $Q_i(t)$ in $\varphi$ with the propositional atom $q_i$. This resulting formula is clearly equivalent to $\varphi$ when evaluated at any time point $t$. Notably, it's a \textit{pure-present} formula.
        \item[Induction case.] Suppose $\varphi(t)$ has quantifier depth $n$. Write $\varphi(t)$ in the form presented in \cref{corollary:separate-present-form-fomlo}.
        \begin{equation}
            \label{eq:present-separate-form-fomlo}
            \varphi(t) \equiv \bigvee_i \left( \beta_i(t) \land \bigwedge_j \left( \pm \exists y.\, \alpha_{i, j}\left(t, y\right) \right) \right)
        \end{equation}
        Observe that one can easily construct a pure-present temporal formula $\rho_i$ for each $\beta_i(t)$. Hence, we focus our attention on the $\exists y.\, \alpha(t, y)$. We start by getting rid of all instances of the variable $t$ in $\alpha$ by introducing a few new monadic relations.

        Introduce three new monadic symbols $R_<$, $R_=$, and $R_>$. In each $\alpha$, substitute all atomic formulas that involve $t$ in the following way.
        \begin{equation*}
            \begin{aligned}
                x < t &\longmapsto R_<(x)\\
                x = t &\longmapsto R_=(x)\\
                t < x  &\longmapsto R_>(x)
            \end{aligned}
        \end{equation*}
        By \cref{corollary:separate-present-form-fomlo}, these are the only instances of $t$ in $\alpha$. Call the resulting formula $\alpha'$. Transforming each $\alpha$ in $\varphi$ in this way produces the formula $\varphi'$, defined below
        \begin{equation}
            \label{eq:present-separate-form-fomlo-without-t}
            \varphi'(t) \triangleq \bigvee_i \left( \beta_i(t) \land \bigwedge_j \left( \pm \exists y.\, \alpha'_{i, j}\left(y\right) \right) \right)
        \end{equation}
        Observe that each $\alpha'$ in $\varphi'$ satisfies the following properties.
        \begin{alphaenumerate}
            \item Their quantifier depth is at-most $n - 1$.
            \item They have a single free-variable ($y$).
            \item They are equivalent to $\alpha$ \textit{if} $R_<$, $R_=$, and $R_>$ are modelled appropriately (which we'll discuss in a later part of the proof).
        \end{alphaenumerate}
        These conditions allow us to use the induction hypothesis on $\alpha'$ to produce a temporal formula $\gamma$. Notably, since the increased pool of monads has created the new propositional atoms $r_>$, $r_=$, and $r_<$. $\gamma$ may contain these atoms.

        Now, observe that the existential quantifier in $\exists y.\, \alpha'(y)$ can be expressed in the temporal language as $\diamond \gamma$, where $\diamond$ is shorthand for \textit{at some point in time}. $\diamond$ can be expressed with $S$ and $U$ as follows:
        \begin{equation*}
            \diamond \gamma \equiv \gamma \lor U(\gamma,\top) \lor S(\gamma, \top)
        \end{equation*}

        We proceed to construct temporal formulas $\gamma_{i, j}$ for each $\alpha'_{i, j}$ in \eqref{eq:present-separate-form-fomlo-without-t}. This allows us to construct the monolithic temporal formula $\psi$:
        \begin{equation*}
            \psi \triangleq \bigvee_i \left( \rho_i \land \bigwedge_j \left( \pm \diamond \gamma_{i, j} \right) \right)
        \end{equation*}
        Again, if $r_<$, $r_=$, and $r_>$ are appropriately modelled, $\psi$ is equivalent to $\varphi(t)$.

        Using \cref{theorem:separation-linear-final}, we now \textit{separate} $\psi$ into a boolean combination of pure-past, present, and future formulas. We write the separated formula as follows:
        \begin{equation*}
            \psi \equiv \mathbf{B}(\psi_{<, 1}, \ldots, \psi_{<. m_<}, \psi_{=, 1}, \ldots, \psi_{<, m_=}, \psi_{>, 1}, \ldots \psi_{>, m_>})
        \end{equation*}
        where $\mathbf{B}$ abstracts the boolean combinations and the $\psi_{<, i}$, $\psi_{=, i}$, and $\psi_{>, i}$ are pure-past, present, and future formulas.

        We earlier stated that if $R_<$, $R_=$, and $R_>$ are appropriately modelled, $\psi$ is equivalent to $\varphi(t)$. The correct values of $R_<$, $R_=$, and $R_>$ are, quite naturally,
        \begin{equation*}
            \begin{aligned}
                R_< &= \{s \mid s < t\}\\
                R_= &= \{t\}\\
                R_> &= \{s \mid t < s\}
            \end{aligned}
        \end{equation*}
        Let the partial assignment of atoms over the flow of time $h$ represent this model.

        Now, consider a partial assignment $h_<$ that agrees with $h$ on all atoms but $r_<$, $r_=$, and $r_>$. $h_<$ models $r_<$ to $\top$ everywhere, and $r_>$ and $r_=$ to $\bot$ everywhere. This assignment, by its definition, agrees with $h$ on the past of $t$, and consequently, for each pure-past $\psi_{<, i}$,
        \begin{equation*}
            h \vDash \psi_{<, i} \longleftrightarrow h_< \vDash \psi_{<, i}
        \end{equation*}
        Construct the formula $\psi'_{<, i}$ by substituting all instances of $r_<$ in $\psi_{<, i}$ by $\top$ and all instances of $r_=$ and $r_>$ by $\bot$, i.e.,
        \begin{equation*}
            \psi'_{<, i} \triangleq \psi_{<, i} \left[ \begin{smallmatrix}
                r_< \mapsto \top\\
                r_= \mapsto \bot\\
                r_> \mapsto \bot
            \end{smallmatrix} \right]
        \end{equation*}
        It's easy to see that
        \begin{equation*}
            h_< \vDash \psi_{<, i} \longleftrightarrow h_< \vDash \psi'_{<, i}
        \end{equation*}
        Hence,
        \begin{equation*}
            h \vDash \psi_{<, i} \longleftrightarrow h_< \vDash \psi_{<, i} \longleftrightarrow h_< \vDash \psi'_{<, i}
        \end{equation*}
        Observe that $\psi'_{<, i}$ no longer uses the additional atoms! And since $h$ and $h_<$ agree on all other atoms,
        \begin{equation*}
            h \vDash \psi_{<, i} \longleftrightarrow h \vDash \psi'_{<, i}
        \end{equation*}
        We can similarly substitute the atoms in the $\psi_{>, i}$ and $\psi_{=, i}$ to get rid of $r_<$, $r_=$, and $r_>$ in $\psi$. Call this new formula $\psi'$.
        \begin{equation*}
            \psi' \triangleq \mathbf{B}(\psi'_{<, 1}, \ldots, \psi'_{<. m_<}, \psi'_{=, 1}, \ldots, \psi'_{<, m_=}, \psi'_{>, 1}, \ldots \psi'_{>, m_>})
        \end{equation*}
        We claim that $\psi'$ is equivalent to $\varphi(t)$. To see why, take any linear temporal structure $\mathcal{M} = (T, <, h)$ and a point $t \in T$ in the flow. Let $h'$ be the extension of $h$ with the appropriate valuations of $R_<$, $R_=$ and $R_>$ and $\mathcal{M}'$ be $(T, <, h')$. It's easy to see that the following double-implications immediately hold:
        \begin{equation*}
            \begin{aligned}
                \mathcal{M}, t \vDash \varphi(t) \;\Longleftrightarrow\; \mathcal{M}', t \vDash \varphi'(t)
                \;\Longleftrightarrow\; \mathcal{M}', t \vDash \psi
                \;\Longleftrightarrow\; \mathcal{M}, t \vDash \psi'
            \end{aligned}
        \end{equation*}
        This proves the separation theorem.
    \end{description}
\end{proof}

\section{Ordered Trees}
\label{sec:ordered-trees}

% TODO: Think up a better introduction of ordered trees.

Flows of time can be more complicated than the linear structures we've seen so far. The notion of branching time, where the flow resembles a tree, is a well known example. While temporal languages over unordered trees have been studied quite extensively (see \cite{RabinovichUnordered00}), in this work we look at ordered trees.

In addition to the descendent order (which corresponds to the natural forward flow of time), ordered trees use a \textit{sibling} order. Correspondingly, the first-order vocabulary includes two binary relations: $<$ and $\prec$, where $x < y$ indicates $y$ is a descendant of $x$ and $x \prec y$ indicates $y$ comes after $x$ in the sibling order. All immediate children of a node are totally ordered by $\prec$. %TODO: Consider adding an axiom that describes the limits of $\prec$ and $<$.

In \cite{xpathComplete}, Marx introduced the temporal language $\mathcal{X}_{until}$ over ordered trees. This language has the same expressive power as \textit{Conditional XPath}, which Marx proved to be expressively complete in \cite{marx2005conditional}. It defines four connectives that are similar to the strict $U$ and $S$ Gabbay defines for linear time. These are $\Larrow$, $\Rarrow$, $\Uarrow$, and $\Darrow$, defined by the following monadic first-order formulas.
\begin{equation*}
    \begin{aligned}
        \varphi_{\Darrow}(t, X_1, X_2) &\triangleq \exists x.\, \left[ \left( t < x \right) \land X_1(x) \land \forall y \left( \left( t < y < x \right) \to X_2(y) \right) \right]\\
        \varphi_{\Uarrow}(t, X_1, X_2) &\triangleq \exists x.\, \left[ \left( x < t \right) \land X_1(x) \land \forall y \left( \left( x < y < t \right) \to X_2(y) \right) \right]\\
        \varphi_{\Rarrow}(t, X_1, X_2) &\triangleq \exists x.\, \left[ \left( t \prec x \right) \land X_1(x) \land \forall y \left( \left( t \prec y \prec x \right) \to X_2(y) \right) \right]\\
        \varphi_{\Larrow}(t, X_1, X_2) &\triangleq \exists x.\, \left[ \left( x \prec t \right) \land X_1(x) \land \forall y \left( \left( x \prec y \prec t \right) \to X_2(y) \right) \right]
    \end{aligned}
\end{equation*}
Marx suggested a separation property for this temporal language over ordered trees. The regions he proposed, with respect to an arbitrary point $t$ in the flow, were
\begin{itemize} %TODO: Describe Marx's regions here.
    \item The \textit{present} point, which we call $t$.
    \item The \textit{future}, defined as $\{x \mid t < x \}$.
    \item The \textit{left} of $t$, defined as $\{x \mid x \prec t \lor \exists y.\, y \prec t \land y < x \}$.
    \item The \textit{right} of $t$, defined analogously as $\{x \mid t \prec x \lor \exists y.\, t \prec y \land y < x \}$.
    \item The \textit{past}, which consists of all points not claimed by other regions.
\end{itemize}
\cref{fig:marx-regions} shows how these regions partition the tree.
\begin{figure}[h]
    \centering
    \tikzfig{separation-tree-marx}
    \caption[]{Marx's regions. The black node is the present, the \textcolor{orange}{orange} nodes belong to the \textit{left} region, the \textcolor{red}{red} nodes to the \textit{right}, the \textcolor{blue}{blue} nodes are the \textit{future}, and the \textcolor{OliveGreen}{green} nodes are the \textit{past}. The descendant relation is given by the black lines and the sibling order is denoted by the \textcolor{red}{red} lines. Dashed lines indicate potential intermediate nodes.}
    \label{fig:marx-regions}
\end{figure}

Unfortunately, Marx's proof of separation in \cite{xpathComplete} is incorrect. He fails to take into consideration that the $\Darrow$ modality is non-deterministic. This indicates that one cannot extend equation \eqref{eq:or-and-S-U} to $\Darrow$, as
\begin{equation*}
    \Darrow(a, b \land c) \not\equiv \Darrow(a, b) \land \Darrow(a, c)
\end{equation*}
This is made explicit in \cref{fig:darrow-a-b-and-c}.
\begin{figure}[h]
    \centering
    \tikzfig{darrow-a-b-and-c}
    \caption[]{This is an example that satisfies $\Darrow(a, b)$ and $\Darrow(a, c)$, but not $\Darrow(a, b \land c)$.}
    \label{fig:darrow-a-b-and-c}
\end{figure}

In the next few sections, we show that a certain class of formulas in $\mathcal{X}_{until}$ can be separated. We also show a few results that show that certain formulas can never be separated into these regions.

\subsection{Partial Separation of $\mathcal{X}_{until}$}

As with linear flows, we can define a notion of syntactically pure formulas in $\mathcal{X}_{until}$. Again, to simplify presentation, we refer to formulas rooted by a $\pi$ for $\pi \in \{\Larrow, \Rarrow, \Uarrow, \Darrow\}$ as a $\pi$-formula.
\begin{definition}
    A temporal formula $\varphi$ in $\mathcal{X}_{until}$ is
    \begin{enumerate}
        \item syntactically pure-present if it doesn't use any connectives.
        \item syntactically pure-future if it's a boolean combination of $\Darrow$-formulas that don't use the $\Uarrow$ connective.
        \item syntactically pure-left if it's a boolean combination of $\Larrow$-formulas that contain pure-present, pure-future and/or smaller $\Larrow$-formulas of this form.
        \item syntactically pure-right if it's a boolean combination of $\Rarrow$-formulas that contain pure-present, pure-future, and/or smaller $\Rarrow$-formulas of this form.
        \item syntactically pure-past if it's a boolean combination of $\Uarrow$-formulas that contain pure-present, pure-left, pure-right, and/or smaller $\Uarrow$-formulas of this form.
    \end{enumerate}
\end{definition}

It's simple enough to observe that all syntactically pure formulas are semantically pure. To simplify our arguments, we also introduce the notion of the \textit{pure $\pi$ formula} for $\pi \in \{ \Larrow, \Rarrow, \Darrow, \Uarrow \}$. Simply put, a formula is pure $\pi$ \textit{iff} the only connective it uses is $\pi$.

In this subsection, we aim to show the following theorem.
\begin{theorem}[Partial Separation of $\mathcal{X}_{until}$]
    \label{theorem:partial-separation-trees}
    Let $\varphi$ be a formula in $\mathcal{X}_{until}$ such that all $\Darrow$-subformulas of $\varphi$ are syntactically pure-future. Then, $\varphi$ can be separated.
\end{theorem}
This theorem can be seen as a consequence of two facts. First, \eqref{eq:or-and-S-U} is valid for the modalities $\pi \in \{\Uarrow, \Larrow, \Rarrow\}$. Second, the eliminations presented in \cite{xpathComplete} prove that formulas of the form $\Uarrow(a \land \pm \Darrow(p, q), b \lor \pm \Darrow(p, q))$ can be separated.

\subsubsection{Separating $\Larrow$, $\Rarrow$ and $\Uarrow$}

Before we prove \cref{theorem:partial-separation-trees}, we prove a few lemmas.
\begin{lemma}
    \label{lemma:partial-separation-trees-step1}
    Let $\varphi$ be a formula in $\mathcal{X}_{until}$ that doesn't use the $\Uarrow$ and $\Darrow$ connectives. Then, $\varphi$ can be separated.
\end{lemma}
\begin{proof}
    This is a simple consequence of \cref{theorem:separation-linear-final}. Observe that $\varphi$ can only use the $\Larrow$ and $\Rarrow$ connectives, and that the directions of these connectives prevent $\varphi$ from probing nodes that aren't siblings of the present point $t$. Moreover, their operation mirrors that of $S$ and $U$ over linear time. Since the sibling order $\prec$ over all siblings of a node produces a total-order, we're justified in applying \cref{theorem:separation-linear-final}.
\end{proof}
Next, we lift a few eliminations from \cite{xpathComplete}.
\begin{lemma}
    \label{lemma:partial-separation-trees-step2}
    The following eliminations are valid.
    \begin{itemize}
        \item $\Larrow(\alpha \land \mathord{\Uarrow}(\varphi, \psi), \beta) \equiv \Larrow(\alpha, \beta) \land \Uarrow(\varphi, \psi)$
        \item $\Larrow(\alpha \land \lnot \Uarrow (\varphi, \psi), \beta) \equiv \Larrow(\alpha, \beta) \land \lnot \Uarrow(\varphi, \psi)$
        \item $\Larrow(\alpha, \beta \lor \Uarrow(\varphi, \psi)) \equiv \Larrow(\alpha, \beta) \lor \left( \Larrow(\alpha, \top) \land \Uarrow(\varphi, \psi) \right)$
        \item $\Larrow(\alpha, \beta \lor \lnot \Uarrow(\varphi, \psi)) \equiv \Larrow(\alpha, \beta) \lor \left( \Larrow(\alpha, \top) \land \lnot \Uarrow(\varphi, \psi) \right)$
    \end{itemize}
\end{lemma}
\begin{proof}
    These equivalences follow from the fact that the truth of $\pm \Uarrow(\varphi, \psi)$ at a sibling of $t$ implies $\pm \Uarrow(\varphi,\psi)$ at $t$. The eliminations merely explicate this fact.
\end{proof}
\begin{note*}
    These eliminations \textit{don't} proliferate the parameters of the $\Uarrow$ connective. The eliminations we observed in \cref{sec:eliminations-linear} don't have this property.
\end{note*}
We now implement these eliminations in a more general setting.
\begin{lemma}
    \label{lemma:partial-separation-trees-step3}
    Let $\alpha$ and $\beta$ be formulas in $\mathcal{X}_{until}$ that (1) don't use the $\Larrow$, $\Rarrow$ and $\Darrow$ connectives, and (2) only use the $\Uarrow$ connective to insert the subformula $\Uarrow(\varphi, \psi)$ for some $\mathcal{X}_{until}$ formulas $\varphi$ and $\psi$. Then, $\Larrow(\alpha, \beta)$ can be written as a boolean combination of pure-$\Larrow$ formulas and $\Uarrow(\varphi, \psi)$.
    \begin{remark*}
        This lemma only yields a separated formula if $\Uarrow(\varphi, \psi)$ is a pure-past formula.
    \end{remark*}
\end{lemma}
\begin{proof}
    Since $\Larrow$ and $\Rarrow$ satisfy a version of \eqref{eq:or-and-S-U}, we can follow the procedure outlined in \cref{lemma:separation-linear-step1} and write $\Larrow(\alpha, \beta)$ in the manner of \eqref{eq:dnf-form-S-alpha-beta} to get
    \begin{equation*}
        \Larrow(\alpha, \beta) \equiv \bigvee_i \bigwedge_j \Larrow\left(\alpha_{i, 1} \land \cdots \land \alpha_{i, m_i}, \beta_{j, 1} \lor \cdots \lor \beta_{j, n_i} \right)
    \end{equation*}
    As in \cref{lemma:separation-linear-step1}, the $\Larrow$-formula for each $\{i, j\}$ can be considered to be in the form of
    \begin{equation*}
        \begin{aligned}
            &\Larrow(\alpha' \land \pm \Uarrow(\varphi, \psi), \beta')\\
            &\Larrow(\alpha', \beta' \lor \pm \Uarrow(\varphi, \psi))\\
            &\Larrow(\alpha' \land \pm \Uarrow(\varphi, \psi), \beta' \lor \pm \Uarrow(\varphi, \psi))\\
        \end{aligned}
    \end{equation*}
    We can apply the eliminations detailed in \cref{lemma:partial-separation-trees-step2} to complete the proof.
\end{proof}
We now generalize this lemma a little further.
\begin{lemma}
    \label{lemma:partial-separation-trees-step4}
    Take an expanded set of atoms $\mathcal{P}' \triangleq \mathcal{P} \cup \{\Uarrow(\varphi, \psi)\}$. Suppose $\gamma$ is a formula in $\mathcal{X}_{until}$ that only uses the $\Larrow$ connective and takes atoms from $\mathcal{P}'$. Then, $\gamma$ is equivalent to a boolean combination of pure-$\Larrow$ formulas, atoms in $\mathcal{P}$, and the formula $\Uarrow(\varphi, \psi)$.
\end{lemma}
\begin{proof}
    Despite the stricter wording, this lemma is the counterpart of \cref{lemma:separation-linear-step2} with the connectives $S$ and $U$ substituted by $\Larrow$ and $\Uarrow$. As with that lemma, we induct on $(n_1, n_2)$, where $n_1$ is the highest $\Larrow$-depth at which a $\Uarrow(\varphi, \psi)$ appears in $\gamma$ and $n_2$ is the number of instances of $\Uarrow(\varphi, \psi)$ at depth $n_1$.
    \begin{description}
        \item[Base case.] $(n_1, n_2) = (1, 1)$. This is equivalent to \cref{lemma:partial-separation-trees-step3}.
        \item[Induction step.] Take a subformula $\Larrow(\alpha', \beta')$ at $\Larrow$-depth $(n-1)$ such that (1) $\Larrow$ doesn't appear in $\alpha'$ and $\beta'$, and (2) $\Uarrow(\varphi, \psi)$ appears in at-least one of $\alpha'$ and $\beta'$. It's easy to see that applying \cref{lemma:partial-separation-trees-step3} to $\Larrow(\alpha', \beta')$ strictly reduces $(n_1, n_2)$, allowing us to apply the induction hypothesis.
    \end{description}
    \begin{remark*}
        Since $\varphi$ and $\psi$ aren't proliferated in \cref{lemma:partial-separation-trees-step2}, they don't enter the pure-$\Larrow$ formulas in this lemma.
    \end{remark*}
\end{proof}
We now consider the case of multiple $\Uarrow$-formulas inside a $\Larrow$-formula.
\begin{lemma}
    \label{lemma:partial-separation-trees-step5}
    Take an expanded set of atoms $\mathcal{P}' \triangleq \mathcal{P} \cup \{\Uarrow(\varphi_1, \psi_1), \ldots, \Uarrow(\varphi_n, \psi_n)\}$. Suppose $\gamma$ is a formula in $\mathcal{X}_{until}$ that only uses the $\Larrow$ connective and takes atoms from $\mathcal{P}'$. Then, $\gamma$ is equivalent to a boolean combination of pure-$\Larrow$ formulas, atoms in $\mathcal{P}$, and the $\Uarrow(\varphi_i, \psi_i)$ formulas.
\end{lemma}
\begin{proof}
    This is the counterpart of \cref{lemma:separation-linear-step3}. Predictably, we prove this by inducting on $n$. The details are left to the reader. %TODO: Ask if this is lazy in the meeting.
    \begin{remark*}
        Again, the structure of the $\Uarrow$-formulas is maintained during the transformation.
    \end{remark*}
\end{proof}
Before we proceed with the next result, note that Lemmas \ref{lemma:partial-separation-trees-step3}, \ref{lemma:partial-separation-trees-step4}, and \ref{lemma:partial-separation-trees-step5} are valid when the $\Larrow$ is replaced by a $\Rarrow$.
\begin{lemma}
    \label{lemma:partial-separation-trees-step6}
    Take an expanded set of atoms $\mathcal{P}' \triangleq \mathcal{P} \cup \{\Uarrow(\varphi_1, \psi_1), \ldots, \Uarrow(\varphi_n, \psi_n)\}$. Suppose $\gamma$ is a formula in $\mathcal{X}_{until}$ that only uses the $\Larrow$ and $\Rarrow$ connectives and takes atoms from $\mathcal{P}'$. Then, $\gamma$ is equivalent to a boolean combination of pure-$\Larrow$ formulas, pure-$\Rarrow$ formulas, atoms in $\mathcal{P}$, and the $\Uarrow(\varphi_i, \psi_i)$.
\end{lemma}
\begin{proof}
    Introduce new atoms $r_1, \ldots, r_n$ to $\mathcal{P}$ to produce $\mathcal{P}''$. In $\gamma$, replace each instance of $\Uarrow(\varphi_i, \psi_i)$ with $r_i$ to produce the formula $\gamma'$. Notice that $\gamma'$ has no $\Uarrow$-subformulas. Separate $\gamma'$ according to \cref{lemma:partial-separation-trees-step1} to get
    \begin{equation*}
        \gamma' \equiv \mathbf{B}(\gamma_{\Larrow, 1}, \ldots, \gamma_{\Larrow, n_{\Larrow}}, \gamma_{\Rarrow, 1}, \ldots, \gamma_{\Rarrow, n_{\Rarrow}}, \gamma_{=, 1}, \ldots \gamma_{=, n_=})
    \end{equation*}
    where all $\gamma_{\Larrow, i}$ formulas only use the $\Larrow$ connective, all $\gamma_{\Rarrow, j}$ formulas only use the $\Rarrow$ connective, and all $\gamma_{=, k}$ use no connectives.. At this stage, replace all instances of $r_i$ by $\Uarrow(\varphi_i, \psi_i)$ in the $\gamma_{\Larrow, i}$, $\gamma_{\Rarrow, j}$, and $\gamma_{=, k}$ to produce $\gamma'_{\Larrow, i}$, $\gamma'_{\Rarrow, j}$ and $\gamma'_{=, k}$. The $\gamma'_{=, k}$ already satisfy our condition; hence, we only apply \cref{lemma:partial-separation-trees-step5} to the others to prove this lemma.
\end{proof}
We can now state an interesting corollary.
\begin{corollary}
    \label{corollary:partial-separation-without-down}
    Let $\gamma$ be a formula in $\mathcal{X}_{until}$ that doesn't use the $\Darrow$ connective. Then, $\gamma$ can be separated.
\end{corollary}
\begin{proof}
    This is a simple matter of noticing that all $\Uarrow$-formulas that don't use the $\Darrow$ connective are syntactically pure-past.
\end{proof}

\subsubsection{Separating $\Darrow$, $\Rarrow$, and $\Larrow$}
At this stage, we begin considering pure-future $\Darrow$-formulas. It's simple to notice that any formula that only uses the $\Larrow$ (or $\Rarrow$) and $\Darrow$ connectives is immediately syntactically separated; it is a boolean combination of syntactically pure-left (or pure-right) and pure-future formulas. It's easy to extend this observation to show the following lemma.
\begin{lemma}
    \label{lemma:partial-separation-trees-step7}
    Let $\gamma$ be a formula in $\mathcal{X}_{until}$ that doesn't use the $\Uarrow$ connective. Then, $\gamma$ can be separated.
\end{lemma}
\begin{proof}
    Let $\Darrow(\varphi_1, \psi_1), \ldots, \Darrow(\varphi_n, \psi_n)$ be $\gamma$'s $\Darrow$-subformulas that don't appear under ths scope of a $\Darrow$ (i.e., they're the \textit{top-level} $\Darrow$-subformulas). Introduce new atoms $\{r_1, \ldots, r_n\}$ and for each $i \in \{1, \ldots, n\}$, replace the instance of the subformula $\Darrow(\varphi_i, \psi_i)$ in $\gamma$ with $r_i$ to produce the formula $\gamma'$.

    Observe that $\gamma'$ only uses the $\Larrow$ and $\Rarrow$ connectives. This allows us to use \cref{lemma:partial-separation-trees-step1} separate $\gamma'$. In the separated formula, substitute all instances of $r_i$ with $\Downarrow_i(\varphi_i, \psi_i)$. It's easy to see that, after substitution, we get a syntactically separated formula.
\end{proof}
We can extend this reasoning further by reusing the method used to prove \cref{lemma:partial-separation-trees-step6}.
\begin{corollary}
    \label{lemma:partial-separation-trees-step8}
    Let $\gamma$ be a $\mathcal{X}_{until}$ formula such that all $\Darrow$ subformulas are syntactically pure-future and all $\Uarrow$-subformulas are syntactically pure-past. Then, $\gamma$ can be separated.
\end{corollary}
\begin{proof}
    Let $\Darrow(\varphi_1, \psi_1), \ldots, \Darrow(\varphi_n, \psi_n)$ be all subformulas of $\gamma$ that (1) don't appear under a $\Darrow$ and (2) don't appear under a $\Uarrow$. Note that, as all $\Uarrow$-subformulas are syntactically pure-past, any $\Darrow$-subformula that appears under a $\Uarrow$ must have an $\Larrow$ or $\Rarrow$ between it and the $\Uarrow$. Also, note that each $\Darrow(\varphi_i, \psi_i)$ are syntactically pure-future. %TODO: Possible diagram here.

    Introduce $n$ new atoms $r_1, \ldots r_n$ and substitute each $\Darrow(\varphi_i, \psi_i)$ in $\gamma$ by $r_i$. Note that no $r_i$ is embedded under a $\Uarrow$. Call this new formula $\gamma'$. It's easy to observe that one can apply \cref{lemma:partial-separation-trees-step6} to separate $\gamma'$. Let the separated formula be $\gamma''$. Since no $r_i$ is under a $\Uarrow$ in $\gamma'$, no $r_i$ is under a $\Uarrow$ in $\gamma''$.

    Hence, all $r_i$ must occur as a pure-present atom or inside a pure-$\Larrow$ formula or a pure-$\Rarrow$ formula in $\gamma''$. Substituting $\Darrow(\varphi_i, \psi_i)$ for each $r_i$ keeps the formula separated, proving the lemma.
\end{proof}

%\subsubsection{Normal Form} % Consider deleting
%We've reached another checkpoint in our proof of \cref{theorem:partial-separation-trees}. At this stage, it's clear that only the case where the pure-future $\Darrow$-formula is inside an $\Uarrow$-formula remains. To facilitate progress, we consider a \textit{standard form} for pure-past $\Uarrow$-formulas.
%\begin{definition}
%    Let $\gamma = \Uarrow(\varphi, \psi)$ be a formula in $\mathcal{X}_{until}$ such that $\varphi$ and $\psi$ are of the form
%    \begin{equation*}
%        \begin{aligned}
%            \varphi \triangleq \bigwedge_i \pm \varphi_i && \psi \triangleq \bigvee_j \pm \psi_j
%        \end{aligned}
%    \end{equation*}
%    where $\varphi_i$ and $\psi_j$ are either atoms, pure-left $\Larrow$-formulas, pure-right $\Rarrow$-formulas, or smaller $\Uarrow$-formulas in standard form. Then, $\gamma$ is a $\Uarrow$-formula in standard form.
%\end{definition}
%It's easy to see that all standard-form $\Uarrow$-formulas are syntactically pure-past. However, the next result makes these more useful.
%\begin{lemma}
%    \label{lemma:partial-separation-trees-step9}
%    Let $\gamma$ be a syntactically pure-past formula in $\mathcal{X}_{until}$. Then, $\gamma$ can be written as a boolean combination of $\Uarrow$-formulas in standard form.
%\end{lemma}
%\begin{proof}
%    Since $\gamma$ is a boolean combination of syntactically pure-past $\Uarrow$-formulas, we limit our discussion to the case where $\gamma$ is a $\Uarrow$ formula. Hence,
%    \begin{equation*}
%        \gamma \triangleq \Uarrow(\varphi, \psi)
%    \end{equation*}
%    We begin by inducting on the $\Uarrow$-depth of $\gamma$.
%    \begin{description}
%        \item[Base case.] The $\Uarrow$-depth of $\gamma$ is 1. This means $\varphi$ and $\psi$ only use the $\Larrow$, $\Rarrow$, and $\Darrow$ connectives. We hence use \cref{lemma:partial-separation-trees-step7} to separate them to $\varphi'$ and $\psi'$. Since $\gamma$ is a syntactically pure-past formula, $\varphi'$ and $\psi'$ will be boolean combinations of atoms, pure-left $\Larrow$-formulas, pure-right $\Rarrow$-formulas. Writing $\varphi'$ and $\psi'$ in DNF and CNF form gives us
%        \begin{equation*}
%            \begin{aligned}
%                \varphi' &\equiv \bigvee_i \bigwedge_j \pm \varphi'_{i, j}\\
%                \psi' &\equiv \bigwedge_i \bigvee_j \pm \psi'_{i, j}
%            \end{aligned}
%        \end{equation*}
%        where each $\varphi'_{i, j}$ and $\psi'_{i, j}$ are pure-left $\Larrow$-formulas, pure-right $\Rarrow$-formulas, or atoms. Hence, by token of the procedure used in \eqref{eq:dnf-form-S-alpha-beta}, we have
%        \begin{equation*}
%            \begin{aligned}
%                \Uarrow(\varphi, \psi) \equiv \bigvee_i \bigwedge_j \Uarrow(\pm \varphi'_{i, 1} \land \cdots \land \pm \varphi'_{i, n_i} , \pm \psi'_{j, 1} \lor \cdots \lor \pm \psi'_{j, m_j})
%            \end{aligned}
%        \end{equation*}
%        This final form is clearly in standard form.
%
%        \item[Induction step.] Let $\Uarrow(\alpha, \beta), \ldots, \Uarrow(\alpha, \beta)$ be all of $\varphi$'s and $\psi$'s $\Uarrow$-subformulas that aren't under the scope of a $\Uarrow$. Since these subformulas have a strictly lower $\Uarrow$-depth than $\gamma$, we can apply the induction hypothesis to produce equivalent boolean combinations of $\Uarrow$-formulas in standard form for each $\Uarrow(\alpha_i, \beta_i)$. Simply substitute these formulas for $\Uarrow(\alpha_i, \beta_i)$ in $\varphi$ and $\psi$ to produce formulas $\varphi'$ and $\psi'$ in which each $\Uarrow$-subformula is in standard form. This gives us the new formula $\gamma'$ equivalent to $\gamma$:
%        \begin{equation*}
%            \gamma' \triangleq \Uarrow(\varphi', \psi')
%        \end{equation*}
%        Notice that the separation procedure described in the proof of \cref{lemma:partial-separation-trees-step8} maintains the structure of the pure-past $\Uarrow$-subformulas in the separated form. Directly applying that lemma on $\varphi'$ and $\psi'$ produces the separated formulas $\varphi''$ and $\psi''$. As in the base case, we can write $\varphi''$ in DNF and $\psi''$ in CNF to complete the proof.
%    \end{description}
%\end{proof}

\subsubsection{Pulling out $\Darrow$ from $\Uarrow$}
\label{sec:eliminations-trees}

We now restate some of the eliminations justified in the appendix of \cite{xpathComplete}. These eliminations make vital use of the formula $\theta$, defined as
\begin{equation}
    \label{eq:theta-defn}
    \theta \triangleq \Larrow\left(\varphi \lor \left( \psi \land \Darrow\left( \varphi, \psi \right) \right), \top \right) \lor \Rarrow \left( \varphi \lor \left( \psi \land \Darrow \left( \varphi, \psi \right) \right), \top \right)
\end{equation}
$\theta$ merely states that ``my parent satisfies $\Darrow(\varphi, \psi)$ because of a sibling of mine.'' Hence, $\varphi \lor \theta$ implies $\Darrow(\varphi, \psi)$ at the parent. Similarly, $\lnot \theta$ states that ``no sibling of mine is responsible for my parent satisfying $\Darrow(\varphi, \psi)$.'' Consequently, $\lnot \varphi \land \lnot \psi \land \lnot \theta$ implies $\lnot \Darrow(\varphi, \psi)$ at the parent. Notably, $\theta$ is a disjunction of a pure-left and a pure-right formula, and hence can appear inside the scope of a $\Uarrow$ in a pure-past formula.

Now, we move onto the eliminations.

\paragraph*{$\Uarrow(\alpha \land \Darrow(\varphi, \psi), \beta)$}

This formula requires $\Darrow(\varphi, \psi)$ to be true at the ancestor node that satisfies $\alpha$. The path taken by this $\Darrow$-formula can deviate from the ancestral path to $\alpha$ at any point. With $\theta$, we can measure when it deviates. Hence, this formula is equivalent to
\begin{equation*}
    \begin{aligned}
        &\Uarrow(\beta \land (\theta \lor \varphi) \land \Uarrow(\alpha, \beta \land \psi), \beta) \\
        \lor \quad &\Uarrow(\alpha, \beta \land \psi) \land \left( \theta \lor \varphi \lor \left( \psi \land \Darrow(\varphi, \psi) \right) \right) \\
    \end{aligned}
\end{equation*}

\paragraph*{$\Uarrow(\alpha \land \lnot \Darrow(\varphi, \psi), \beta)$}

We again have an ancestral path to $\alpha$, and at that point $\Darrow(\varphi, \psi)$ cannot be true. This indicates that $\Darrow(\varphi, \psi)$ cannot be true along this ancestral path as well, indicating that, we must either hit a point on the path where $\lnot \varphi \land \lnot \psi$ is true, or we need to force $\lnot \Darrow(\varphi, \psi)$ at the present. This can be observed in the following separated formula.
\begin{equation*}
    \begin{aligned}
        &\Uarrow(\lnot \theta \land \lnot \varphi \land \lnot \psi \land \beta \land \Uarrow(\alpha, \beta \land \lnot \varphi \land \lnot \theta), \beta)\\
        \lor \quad &\Uarrow(\alpha, \beta \land \lnot \varphi \land \lnot \theta) \land \lnot \theta \land ((\lnot \varphi \land \lnot \psi) \lor (\lnot \varphi \land \lnot \Darrow(\varphi, \psi)))
    \end{aligned}
\end{equation*}

\paragraph*{$\Uarrow(\alpha, \beta \lor \Darrow(\varphi, \psi))$}

As in \cref{sec:eliminations-linear}, we use the idea of the \textit{unfulfilled} point. This time, such points are detected by noticing that $\lnot \varphi \land \lnot \theta$ are true along the ancestral path to a $\lnot \beta$. We attempt to fulfil the point by ensuring $(\varphi \lor \theta) \lor \psi$. This gives us the entire formula
\begin{equation*}
    \begin{aligned}
        &\Uarrow(\alpha, \lnot \alpha \land (\Uarrow(\lnot \beta \land \lnot \alpha, \lnot \alpha \land \lnot \varphi \land \lnot \theta) \to (\psi \lor \varphi \lor \theta)))\\
        \land \quad &\Uarrow(\lnot \beta \land \lnot \alpha, \lnot \alpha \land \lnot \varphi \land \lnot \theta) \to (\varphi \lor \theta \lor (\psi \land \Darrow(\varphi, \psi)))
    \end{aligned}
\end{equation*}

\paragraph*{$\Uarrow(\alpha, \beta \lor \lnot \Darrow(\varphi, \psi))$}

Again, as in \cref{sec:eliminations-linear}, we use the idea of a dangerous point. We look for ancestral paths to a $\lnot \beta$ that satisfy $\psi$ at each point. If we find such a path, we enforce $\lnot \varphi \land \lnot \theta$. This gives the formula
\begin{equation*}
    \begin{aligned}
        &\Uarrow(\alpha, \lnot \alpha \land (\Uarrow(\lnot \alpha \land \lnot \beta, \psi \land \lnot \alpha) \to (\lnot \varphi \land \lnot \theta)))\\
        \land \quad &\Uarrow(\lnot \alpha \land \lnot \beta, \psi \land \lnot \alpha) \to (\lnot \theta \land \lnot \varphi \land (\lnot \psi \lor \lnot \Darrow(\varphi, \psi)))
    \end{aligned}
\end{equation*}

In the same vein, we can separate any combination of $\Uarrow(\alpha \pm \Darrow(\varphi, \psi), \beta \lor \pm \Darrow(\varphi, \psi))$. We refer to \cite{xpathComplete} for the full arguments. Notably, if $\alpha$, $\beta$, $\varphi$, and $\psi$ were replaced by atoms, the formulas on the right would be syntactically separated. And if $\theta$ was also replaced by an atom, the formulas on the right only use the $\Uarrow$ and $\Darrow$ connectives. Observe that the only instance of $\Darrow$ in all cases would be $\Darrow(\varphi, \psi)$.

Unfortunately, unlike the eliminations in \cref{lemma:partial-separation-trees-step2}, the parameters of the $\Darrow$ (the $\varphi$ and $\psi$) appear outside of the $\Darrow$ in the separated formula. This complicates our proof.

% Regardless, the only $\Darrow$ subformula in the separated variant is $\Darrow(\varphi, \psi)$. % TODO: NOT TRUE. IF $\varphi$ and $\psi$ appear under a $\Larrow$, then we might have to deal with a different $\Darrow$ formula.

\subsubsection{Final steps}

In the following discussion, we consider $\Uarrow$-formulas that are \textit{almost} pure-past. These are $\Uarrow$-formulas wherein the arguments of every $\Uarrow$-subformula \textit{(including the full formula)} consist of boolean combinations of pure-left $\Larrow$ formulas, pure-right $\Rarrow$ formulas, $\Uarrow$ formulas, and $\Darrow$ formulas. We will later show how to write every $\Uarrow$ formula in this way. In our proof, the $\Darrow$ formulas increase in complexity until we reach our target.

We begin with the following lemma.
\begin{lemma}
    \label{lemma:partial-separation-trees-step10}
    Let $\varphi$ and $\psi$ be boolean combinations of atoms, pure-$\Larrow$, and pure-$\Rarrow$ formulas. Let $\alpha$ and $\beta$ be boolean combinations of atoms, pure-left $\Larrow$-formulas, pure-right $\Rarrow$-formulas, pure-past $\Uarrow$-formulas, and the formula $\Darrow(\varphi, \psi)$. Then, $\gamma \triangleq \Uarrow(\alpha, \beta)$ is equivalent to a separated formula where the only pure-future formula is $\Darrow(\varphi, \psi)$.
    \begin{note*}
        $\varphi$ and $\psi$ could be any formula in $\mathcal{X}_{until}$ that doesn't use the $\Uarrow$ and $\Darrow$ connectives. Simply  \cref{lemma:partial-separation-trees-step1} produces the formulas specified in the statement.
    \end{note*}
\end{lemma}
\begin{proof}
    We start by writing $\alpha$ and $\beta$ in their DNF and CNF forms respectively. This allows us to write $\gamma$ as
    \begin{equation*}
        \gamma \equiv \bigvee_i \bigwedge_j \Uarrow( \pm \alpha_{i, 1} \land \cdots \land \pm \alpha_{i, n_i}, \pm \beta_{j, 1} \lor \cdots \lor \pm \beta_{j, n_j})
    \end{equation*}
    where the $\alpha_{i, k_i}$ and $\beta_{j, k_j}$ can be atoms, instances of $\Darrow(\varphi, \psi)$, and semantically pure $\pi$-formulas for $\pi \in \{\Larrow, \Rarrow, \Uarrow\}$. For each $\{i, j\}$, we can write the corresponding $\Uarrow$-formula in $\gamma$ as
    \begin{equation*}
        \gamma_{i, j} \triangleq \Uarrow(\alpha' \land \pm \Darrow(\varphi, \psi), \beta' \lor \pm \Darrow(\varphi, \psi))
    \end{equation*}
    where \textit{(naturally)} $\alpha'$ and $\beta'$ are conjunctions and disjunctions of semantically pure past, left, present, and right formulas. As we've done many times before, we employ the eliminations detailed in \cref{sec:eliminations-trees} at each $\gamma_{i, j}$.

    Let $A = \{\alpha', \beta', \varphi, \psi\}$ and let $B = A \cup \{\theta\}$ for $\theta$ defined in \cref{eq:theta-defn}. From our discussion in \cref{sec:eliminations-trees}, we know that the eliminations produce syntactically-separated formulas that connect the items in $B$ using the boolean operators, the $\Uarrow$ connective, and the $\Darrow$ connective.

    By the nature of the formulas in $A$, any formula rooted by a $\Uarrow$ that takes atoms from $A$ and only uses the $\Uarrow$ connective is syntactically pure-past. Unfortunately, the addition of the formula $\theta$ doesn't maintain this property; it isn't separated, and its separated equivalent may contain a pure-future formula.

    Remember, $\theta$ only uses the $\Larrow$, $\Rarrow$ and $\Darrow$ connectives. We can produce a separated equivalent $\theta'$ using \cref{lemma:partial-separation-trees-step7}. To safely use the eliminations, we must argue that $\theta'$ contains no pure-future segment. We do so through the following claim.
    \begin{claim*}
        Take any two temporal structures $\mathcal{M} = (T, <, \prec, h)$ and $\mathcal{M}' = (T, <, \prec, h')$ and a point $t \in T$ such that $h$ and $h'$ agree on $t$, the left of $t$, and the right of $t$, but disagree on the future of $t$. We claim that
        \begin{equation*}
            \mathcal{M}, t \vDash \theta \longleftrightarrow \mathcal{M}', t \vDash \theta
        \end{equation*}
        \begin{note*}
            This claim implies that $\theta$ simply doesn't care about the future of $t$.
        \end{note*}
    \end{claim*}
    \begin{claimproof}
        We prove this by contradiction. Suppose, without loss of generality, that $\mathcal{M}, t \vDash \theta$ and $\mathcal{M}', t \nvDash \theta$. Further suppose that
        \begin{equation*}
            \begin{aligned}
                \mathcal{M}, t &\vDash \Larrow(\varphi \lor (\psi \land \Darrow(\varphi, \psi)), \top)\\
                \mathcal{M}', t &\nvDash \Larrow(\varphi \lor (\psi \land \Darrow(\varphi, \psi)), \top)
            \end{aligned}
        \end{equation*}
        The argument for the alternative is similar to this one.

        Suppose $\mathcal{M}, t \vDash \Larrow(\varphi, \top)$. Since $\varphi$ only uses the $\Larrow$ and $\Rarrow$ connectives, the truth of $\varphi$ at $t$ only depends on the assignments of atoms at $t$ and its siblings. Similarly, the truth of $\Larrow(\varphi, \top)$ at $t$ only depends on $t$ and its siblings. Since $\mathcal{M}$ and $\mathcal{M}'$ agree on these nodes, we have $\mathcal{M}', t \vDash \Larrow(\varphi, \top)$.

        Hence, we must have that $\mathcal{M}, t \vDash \Larrow(\psi \land \Darrow(\varphi, \psi), \top)$. Take the left sibling $s \in T$ such that $\mathcal{M}, s \vDash \psi \land \Darrow(\varphi, \psi)$. It's easy to see that $\mathcal{M}$ and $\mathcal{M}'$ agree on $s$, the siblings of $s$, and the future of $s$. Hence, since $\psi$ is only concerned with siblings and $\Darrow(\varphi, \psi)$ is pure-future, we must have $\mathcal{M}', s \vDash \psi \land \Darrow(\varphi, \psi)$. Hence, $\mathcal{M}', t \nvDash \Larrow(\varphi \lor (\psi \land \Darrow(\varphi, \psi)), \top)$, forming a contradiction.
    \end{claimproof}

    We now confidently replace all top-level \textit{(i.e., not under a connective)} pure-future $\Darrow$-formulas (if any exist) in $\theta'$ with $\bot$. This produces $\theta''$, a boolean combination of pure left, present, and right formulas. Let $A' = A \cup \{\theta''\}$. Observe that the desired property is now maintained, i.e., any pure $\Uarrow$ formula taking atoms from $A'$ is syntactically pure-past.

    Call the result of the eliminations $\gamma'_{i, j}$ for each $\{i, j\}$. Replace $\theta$ in $\gamma'_{i, j}$ with $\theta''$ to produce $\gamma''_{i, j}$. Observe now that $\gamma''_{i, j}$ is syntactically separated, and that its pure future segment consists of instances of $\Darrow(\varphi, \psi)$. Hence, the formula
    \begin{equation*}
        \gamma'' \triangleq \bigwedge_i \bigvee_j \gamma''_{i, j}
    \end{equation*}
    is separated and is equivalent to $\gamma$, proving the lemma.
\end{proof}
For the next step, we consider the possible nesting of $\Darrow(\varphi, \psi)$ inside multiple instances of the $\Uarrow$ connective.
\begin{lemma}
    \label{lemma:partial-separation-trees-step11}
    Let $\varphi$ and $\psi$ be boolean combinations of atoms, pure-$\Larrow$ formulas and pure-$\Rarrow$ formulas. Let $\gamma$ be a $\Uarrow$ formula such that the arguments of all $\Uarrow$ subformulas in $\gamma$ are boolean combinations of propositional atoms, pure-left $\Larrow$-formulas, pure-right $\Rarrow$-formulas, and the formula $\Darrow(\varphi, \psi)$. Then, $\gamma$ is equivalent to a separated formula where the only pure-future formula is $\Darrow(\varphi, \psi)$.
\end{lemma}
\begin{proof}
    In this proof, we induct on the maximum $\Uarrow$-depth of a $\Darrow(\varphi, \psi)$ in $\gamma$ that isn't under a $\Larrow$ or a $\Rarrow$.

    \begin{description}
        \item[Base case.] The maximum depth is 1. This is equivalent to \cref{lemma:partial-separation-trees-step10}.
        \item[Induction case.] Let the maximum depth be $n$, and $\Uarrow(\alpha_1, \beta_1), \ldots, \Uarrow(\alpha_m, \beta_m)$ be subformulas of $\gamma$ at $\Uarrow$-depth $n-1$ that contain $\Darrow(\varphi, \psi)$ as a subformula. The maximum depth of $n$ ensures that $\Darrow(\varphi, \psi)$ isn't further nested under a $\Uarrow$ in each $\Uarrow(\alpha_i, \beta_i)$.

        We now apply \cref{lemma:partial-separation-trees-step10} to each $\Uarrow(\alpha_i, \beta_i)$ to produce the separated equivalent $\gamma_i$, with the pure-future segment being $\Darrow(\varphi, \psi)$. Hence, replacing $\Uarrow(\alpha_i, \beta_i)$ with $\gamma_i$ produces a similar formula with a maximum depth of strictly less than $n$. Applying the induction hypothesis to this formula proves the lemma.
    \end{description}
\end{proof}
Note how the structure of the $\Uarrow$ subformulas are maintained in \cref{lemma:partial-separation-trees-step11}. The application of the elimination in \cref{lemma:partial-separation-trees-step10} produces $\Uarrow$-formulas over boolean combinations of pure-left, pure-right and similar $\Uarrow$ formulas. \cref{lemma:partial-separation-trees-step11} does't affect this.

We now consider the case of multiple $\Darrow$ formulas with the same restrictions on the arguments.
\begin{lemma}
    \label{lemma:partial-separation-trees-step12}
    Let $\varphi_1, \ldots, \varphi_n$ and $\psi_1, \ldots, \psi_n$ be any two sequences of $n$ $\mathcal{X}_{until}$ formulas that are boolean combinations of atoms, pure-$\Larrow$ formulas, and pure-$\Rarrow$ formulas. Let $\gamma$ be a $\Uarrow$-formula such that the arguments of every $\Uarrow$-subformula in $\gamma$ are boolean combinations of atoms, pure-left $\Larrow$-formulas, pure-right $\Rarrow$-formulas, pure-past $\Uarrow$-formulas, and formulas from $\{\Darrow(\varphi_i, \psi_i) \mid i \in \{1, \ldots, n\} \}$. Then, $\gamma$ is equivalent to a separated formula where the pure-future formulas are instances of $\{\Darrow(\varphi_1, \psi_1), \ldots, \Darrow(\varphi_n, \psi_n)\}$.
\end{lemma}
\begin{proof}
    Predictably, we induct on $n$.
    \begin{description}
        \item[Base case.] $n = 1$. This case is identical to \cref{lemma:partial-separation-trees-step11}.
        \item[Induction case.] Introduce atoms $r_1, \ldots r_{n-1}$. In $\gamma$, replace all occurrences of $\Darrow(\varphi_i, \psi_i)$ by $r_i$ to produce $\gamma'$. Separate $\gamma'$ according to \cref{lemma:partial-separation-trees-step11} to produce $\gamma''$. Replace the $r_i$ in $\gamma'$ with $\Darrow(\varphi_i, \psi_i)$ to produce $\gamma''$.

        Now, the $r_i$ can appear anywhere in $\gamma'$. If it only appears in pure-left, pure-present, and pure-right segments, replacing it with $\Darrow(\varphi_i, \psi_i)$ maintains the separated nature of the formula. Hence, we focus on the $\Uarrow$ formulas that contain the new atoms.

        Since \cref{lemma:partial-separation-trees-step11} doesn't affect the structure of the $\Uarrow$ formulas, their arguments must be boolean combinations of atoms, pure-left formulas, pure-right formulas, and smaller $\Uarrow$ formulas. If $r_i$ only appears inside these pure-left and pure-right subformula, the $\Uarrow$ formula remains pure-past. The only complex case is if the $r_i$ appears as in the pure-present segment as an atom.

        It's easy to see that we can apply the induction hypothesis on these $\Uarrow$ formulas, as they only contain $n-1$ different $\Uarrow$ formulas embedded in them. Applying them to each top-level $\Uarrow$ formula in $\gamma''$ proves this lemma.
    \end{description}
\end{proof}

We finally consider the case of the $\Darrow$ formula that contains $\Darrow$ subformulas. This lemma is \textit{slightly} more involved than the previous two.
\begin{lemma}
    \label{lemma:partial-separation-trees-step13}
    Let $\gamma_1, \ldots \gamma_n$ be any sequence of $n$ syntactically pure-future $\Darrow$ formulas, and let $\gamma$ be a $\Uarrow$ formula such that the arguments of every $\Uarrow$ subformula in $\gamma$ are boolean combinations of atoms, pure-left formulas, pure-right formulas, pure-past formulas, and formulas from $\{\gamma_1, \ldots, \gamma_n\}$. Then, $\gamma$ can be separated.
\end{lemma}
\begin{proof}
    We begin by defining a measure $\lambda$ on pure-future $\Darrow$ formulas.
    \begin{equation*}
        \lambda(\varphi) = \begin{cases}
            0, & \text{$\varphi$ has no proper $\Darrow$ subformulas}\\
            1 + \max_{\psi \in S(\varphi)} \left\{\lambda\left(\psi\right)\right\} & \text{$S(\varphi)$ contains all proper $\Darrow$ subformulas in $\varphi$}
        \end{cases}
    \end{equation*}
    We induct on the $(m, n)$, where $n$ is the length of the sequence and $m$ is the maximum $\lambda$-score of the formulas in $\{\gamma_1, \ldots, \gamma_n\}$.

    \begin{description}
        \item[Base case.] $m = 0$. All cases of $(0, n)$, for any $n$, is equivalent to \cref{lemma:partial-separation-trees-step12}.
        \item[Induction step.] For each $i$, denote the set of all proper $\Darrow$ subformulas of $\gamma_i$ as $A_i$.
        \begin{equation*}
            A_i = \{ \gamma_{i, 1}, \ldots, \gamma_{i, k_i} \}
        \end{equation*}
        where $k_i$ is the number of such subformulas. Introduce $k_i$ new atoms $\{r_{i, 1}, \ldots r_{i, k_i}\}$ and replace $\gamma_{i, j}$ in each instance of $\gamma_i$ in $\gamma$ with $r_{i, j}$. Call the resulting formula $\gamma'$.

        Observe that $\gamma'$ has introduces $\sum_{j = 1}^{n} k_j$ many new atoms, and that its $\lambda$ score is now 0. We can apply \cref{lemma:partial-separation-trees-step12} to $\gamma'$, producing $\gamma''$. At this stage, we replace all instances of $r_{i, j}$ with $\gamma_{i, j}$, producing $\gamma'''$.

        Again, if $r_{i, j}$ only appears in the pure-left, pure-right, and pure-present segments, $\gamma'''$ remains separated. Again, since \cref{lemma:partial-separation-trees-step12} doesn't change the structure of the $\Uarrow$ subformulas, their arguments in $\gamma''$ remain as boolean combinations of atoms, pure-left, pure-right, and similar $\Uarrow$ subformulas. If $r_{i, j}$ only appears in these pure-left or pure-right subformulas, $\gamma'''$ remains separated.

        Hence, the complex case involves $r_{i, j}$ appearing in a $\Uarrow$ formula without appearing under a $\Larrow$ or a $\Rarrow$. In the worst case, this will involve $\sum_{j=1}^{n} k_j$ new pure-future $\Darrow$ formulas. However, since $\lambda(\gamma_{i, j}) < \lambda(\gamma_i)$, we can apply the induction hypothesis on $\gamma'''$. This completes the proof.
    \end{description}
\end{proof}
At this point, our main result becomes a corollary.
\begin{corollary}[Partial Separation of $\mathcal{X}_{until}$]
    \label{corollary:partial-separation-final}
    Let $\gamma$ be a formula in $\mathcal{X}_{until}$ such that all $\Darrow$ subformulas of $\gamma$ are syntactically pure-future. Then, $\gamma$ can be separated.
\end{corollary}
\begin{proof}
    Let $\{\gamma_1, \ldots, \gamma_n\}$ be the set containing all top-level pure-future $\Darrow$ subformulas in $\gamma$. Introduce $n$ new atoms $r_1, \ldots, r_n$ and replace each instance of $\gamma_i$ in $\gamma$ with $r_i$. Call the resulting formula $\gamma'$.

    Separate $\gamma'$ according to \cref{corollary:partial-separation-without-down}, producing $\gamma''$. In a similar way, separate the arguments of all $\Uarrow$ subformulas in $\gamma'$. Now, replace all $r_i$ in $\gamma''$ with $\gamma_i$ to produce $\gamma'''$. Each top-level $\Larrow$, $\Rarrow$, and $\Darrow$ formulas remain pure after the substitution. Simply apply \cref{lemma:partial-separation-trees-step13} to the top-level $\Uarrow$ formulas to complete the proof.
\end{proof}

% \subsection{More granular regions}
%
%% Note: I hoped to show that Marx's regions couldn't be made more granular as suggested by Gabbay in \cite{gabbay1994}. Unfortunately, the paper Gabbay based his proof on, \cite{Amir85}, uses a different approach to generalization. Amir's conditions are met by Marx's regions, diluting the importance of my findings somewhat.




%%
%% Bibliography
%%

%% Please use bibtex,

\bibliography{refs}

% \appendix
\end{document}
